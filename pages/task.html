<section class="card">
  <h1>タスク管理</h1>
  <div class="notice" id="tk_status">読み込み中...</div>
</section>

<section class="card">
  <div class="btn-row" style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">

    <button id="tk_filterBtn" class="btn secondary">絞り込み</button>

    <!-- 表示切替（一覧 / カレンダー） -->
    <div class="seg" style="display:flex; gap:8px;">
      <button id="tk_viewListBtn" class="btn secondary icon-btn" type="button" aria-label="一覧表示">
        <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
          <path fill="currentColor" d="M8 6h13v2H8V6ZM3 6h3v2H3V6Zm5 5h13v2H8v-2ZM3 11h3v2H3v-2Zm5 5h13v2H8v-2ZM3 16h3v2H3v-2Z"/>
        </svg>
        <span class="sr-only">一覧</span>
      </button>

      <button id="tk_viewCalBtn" class="btn secondary icon-btn" type="button" aria-label="カレンダー表示">
        <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true"
            fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round">
          <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
          <line x1="16" y1="2" x2="16" y2="6"></line>
          <line x1="8" y1="2" x2="8" y2="6"></line>
          <line x1="3" y1="10" x2="21" y2="10"></line>
        </svg>
        <span class="sr-only">カレンダー</span>
      </button>
    </div>

    <div style="flex:1 1 auto;"></div>

    <button id="tk_addBtn" class="btn">追加</button>
    <button id="tk_editBtn" class="btn" disabled>修正</button>
  </div>
</section>

<!-- 一覧ビュー -->
<section class="card" id="tk_listView">
  <h2>タスク一覧</h2>
  <div id="tk_list" style="display:grid; gap:10px; margin-top:12px;"></div>
</section>

<!-- カレンダービュー -->
<section class="card" id="tk_calView" style="display:none;">
  <div class="tk-cal-head">
    <h2 class="tk-cal-h2">カレンダー</h2>
  </div>

  <div class="tk-cal-nav">
    <!-- 中央固定グループ -->
    <div class="tk-cal-center">
      <button id="tk_calPrev" class="btn secondary" type="button">←</button>
      <div id="tk_calTitle" class="tk-cal-title"></div>
      <button id="tk_calNext" class="btn secondary" type="button">→</button>
    </div>

    <!-- 右端 -->
    <button id="tk_calToday" class="btn secondary tk-cal-today" type="button">
      今月
    </button>
  </div>

  <!-- 曜日 -->
  <div id="tk_calWeekdays" style="
    display:grid;
    grid-template-columns:repeat(7, 1fr);
    margin-top:12px;
    color:var(--muted);
    font-size:12px;
  "></div>

  <!-- カレンダー本体（グリッド） -->
  <div id="tk_calendar" style="
    display:grid;
    grid-template-columns:repeat(7, 1fr);
    margin-top:6px;
  "></div>

  <!-- 期限なし -->
  <div style="margin-top:14px;">
    <h3 style="margin:0 0 8px; font-size:14px;">期限なし</h3>
    <div id="tk_noDue" style="display:grid; gap:8px;"></div>
  </div>
</section>

<!-- 絞り込みモーダル（既存） -->
<div id="tk_filterModal" style="display:none; position:fixed; inset:0; z-index:10035; background:rgba(0,0,0,.55);">
  <div style="max-width:560px; margin:10vh auto; padding:14px; border-radius:16px; border:1px solid var(--line); background:rgba(18,26,39,.98);">
    <h2 style="margin:0 0 10px;">絞り込み</h2>

    <div class="grid" style="grid-template-columns:1fr 1fr;">
      <div class="field">
        <div class="label">担当</div>
        <select id="tk_f_assignee">
          <option value="">（指定なし）</option>
        </select>
      </div>

      <div class="field">
        <div class="label">期限（〜まで）</div>
        <input id="tk_f_dueTo" type="date">
      </div>

      <div class="field">
        <div class="label">優先度</div>
        <select id="tk_f_priority">
          <option value="">（指定なし）</option>
          <option value="高">高</option>
          <option value="中">中</option>
          <option value="低">低</option>
        </select>
      </div>

      <div class="field">
        <div class="label">ステータス</div>
        <select id="tk_f_status">
          <option value="">（指定なし）</option>
          <option value="未着手">未着手</option>
          <option value="進行中">進行中</option>
          <option value="確認中">確認中</option>
          <option value="完了">完了</option>
          <option value="破棄">破棄</option>
        </select>
      </div>

      <div class="field" style="grid-column:1 / -1;">
        <div class="label">表示オプション</div>

        <div style="
          display:flex;
          gap:14px;
          flex-wrap:wrap;
          padding:10px;
          border:1px solid var(--line);
          border-radius:12px;
          background:rgba(9,13,21,.35);
        ">
          <label style="display:flex; gap:8px; align-items:center;">
            <input type="checkbox" id="tk_f_showDone">
            <span>完了も表示</span>
          </label>

          <label style="display:flex; gap:8px; align-items:center;">
            <input type="checkbox" id="tk_f_showDiscard">
            <span>破棄も表示</span>
          </label>
        </div>
      </div>
    </div>

    <div class="btn-row" style="margin-top:14px; justify-content:flex-end; gap:10px;">
      <button id="tk_f_clear" class="btn secondary">クリア</button>
      <button id="tk_f_close" class="btn secondary">閉じる</button>
      <button id="tk_f_apply" class="btn btn-primary">適用</button>
    </div>
  </div>
</div>

<!-- 追加/修正モーダル（既存そのまま） -->
<div id="tk_editModal" style="display:none; position:fixed; inset:0; z-index:10035; background:rgba(0,0,0,.55);">
  <div style="height:100%; display:flex; align-items:flex-start; justify-content:center; padding:12px;">
    <div style="
      width:min(720px, 100%);
      max-height:calc(100dvh - 24px);
      border-radius:16px;
      border:1px solid var(--line);
      background:rgba(18,26,39,.98);
      display:flex;
      flex-direction:column;
      overflow:hidden;
    ">
      <div style="padding:14px; border-bottom:1px solid var(--line);">
        <h2 id="tk_editTitle" style="margin:0;">タスク追加</h2>
      </div>

      <div style="padding:14px; overflow:auto; -webkit-overflow-scrolling:touch;">
        <div class="grid" style="grid-template-columns:1fr 1fr;">
          <div class="field" style="grid-column:1 / -1;">
            <div class="label">タスク内容（必須）</div>
            <input id="tk_i_task" placeholder="例：演出シート提出">
          </div>

          <div class="field">
            <div class="label">分類</div>
            <select id="tk_i_category">
              <option value="">（未選択）</option>
              <option value="イベント">イベント</option>
              <option value="統括">統括</option>
              <option value="全体">全体</option>
            </select>
          </div>

          <div class="field">
            <div class="label">ジャンル</div>
            <select id="tk_i_genre">
              <option value="">（未選択）</option>
              <option value="お祭り準備">お祭り準備</option>
              <option value="提出物">提出物</option>
              <option value="スケジュール">スケジュール</option>
              <option value="フォーム">フォーム</option>
              <option value="SNS">SNS</option>
              <option value="スタッフ">スタッフ</option>
              <option value="限定">限定</option>
            </select>
          </div>

          <div class="field">
            <div class="label">担当（複数選択可）</div>
            <div id="tk_i_assigneeBox" style="display:grid; grid-template-columns:1fr 1fr; gap:8px; padding:10px; border:1px solid var(--line); border-radius:12px; background:rgba(9,13,21,.35);"></div>
          </div>

          <div class="field">
            <div class="label">期限</div>
            <input id="tk_i_due" type="date">
          </div>

          <div class="field">
            <div class="label">優先度</div>
            <select id="tk_i_priority">
              <option value="">（未選択）</option>
              <option value="高">高</option>
              <option value="中">中</option>
              <option value="低">低</option>
            </select>
          </div>

          <div class="field">
            <div class="label">ステータス</div>
            <select id="tk_i_status">
              <option value="">（未選択）</option>
              <option value="未着手">未着手</option>
              <option value="進行中">進行中</option>
              <option value="確認中">確認中</option>
              <option value="完了">完了</option>
              <option value="破棄">破棄</option>
            </select>
          </div>

          <div class="field" style="grid-column:1 / -1;">
            <div class="label">備考</div>
            <textarea id="tk_i_note" rows="3" placeholder="補足があれば"></textarea>
          </div>
        </div>
      </div>

      <div class="btn-row" style="padding:14px; border-top:1px solid var(--line); justify-content:flex-end; gap:10px;">
        <button id="tk_i_cancel" class="btn secondary">閉じる</button>
        <button id="tk_i_save" class="btn btn-primary">登録</button>
      </div>
    </div>
  </div>
</div>

<script>
window.taskInit = function taskInit(){
  const $ = (s)=>document.querySelector(s);
  const App = window.App || {};

  const ui = {
    status: $('#tk_status'),
    list: $('#tk_list'),

    listView: $('#tk_listView'),
    calView: $('#tk_calView'),

    btnViewList: $('#tk_viewListBtn'),
    btnViewCal: $('#tk_viewCalBtn'),

    calTitle: $('#tk_calTitle'),
    calPrev: $('#tk_calPrev'),
    calNext: $('#tk_calNext'),
    calToday: $('#tk_calToday'),
    calWeekdays: $('#tk_calWeekdays'),
    calendar: $('#tk_calendar'),
    noDue: $('#tk_noDue'),

    btnFilter: $('#tk_filterBtn'),
    btnAdd: $('#tk_addBtn'),
    btnEdit: $('#tk_editBtn'),

    filterModal: $('#tk_filterModal'),
    f_assignee: $('#tk_f_assignee'),
    f_dueTo: $('#tk_f_dueTo'),
    f_priority: $('#tk_f_priority'),
    f_status: $('#tk_f_status'),
    f_showDone: $('#tk_f_showDone'),
    f_showDiscard: $('#tk_f_showDiscard'),
    f_apply: $('#tk_f_apply'),
    f_close: $('#tk_f_close'),
    f_clear: $('#tk_f_clear'),

    editModal: $('#tk_editModal'),
    editTitle: $('#tk_editTitle'),
    i_task: $('#tk_i_task'),
    i_category: $('#tk_i_category'),
    i_genre: $('#tk_i_genre'),
    i_assigneeBox: $('#tk_i_assigneeBox'),
    i_due: $('#tk_i_due'),
    i_priority: $('#tk_i_priority'),
    i_status: $('#tk_i_status'),
    i_note: $('#tk_i_note'),
    i_cancel: $('#tk_i_cancel'),
    i_save: $('#tk_i_save'),
  };

  const required = [
    ui.status, ui.list, ui.listView, ui.calView,
    ui.btnViewList, ui.btnViewCal,
    ui.calTitle, ui.calPrev, ui.calNext, ui.calToday, ui.calWeekdays, ui.calendar, ui.noDue,
    ui.btnFilter, ui.btnAdd, ui.btnEdit,
    ui.filterModal, ui.editModal,
    ui.f_showDone, ui.f_showDiscard
  ];
  if (required.some(x => !x)) return;

  if (ui.list.dataset.inited === '1') return;
  ui.list.dataset.inited = '1';

  const setStatus = (text, busy) => App.setStatus(ui.status, text, busy);

  const time = {
    toYMD(v){
      if (!v) return '';
      const d = new Date(v);
      if (isNaN(d.getTime())) return '';
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const day = String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${day}`;
    },
    ymdLabel(v){
      const ymd = time.toYMD(v);
      if(!ymd) return '';
      const [,m,d] = ymd.split('-');
      return `${Number(m)}/${Number(d)}`;
    },
    ymdToDate(ymd){
      if(!ymd) return null;
      const [y,m,d] = ymd.split('-').map(Number);
      if (!y || !m || !d) return null;
      return new Date(y, m-1, d);
    }
  };

  const modal = { open: (el)=> App.openModal(el), close: (el)=> App.closeModal(el) };
  const busy = App.makeBusy('タスクを登録してます。\nしばらくお待ちください。', { title: '登録中です…' });

  const isTouch = matchMedia('(hover: none)').matches; // スマホ想定
  const isSp = matchMedia('(max-width: 520px)').matches;

  // =========
  // State
  // =========
  const ASSIGNEE_OPTIONS = ['けいちゃん','キム','小澤','いおり','ジョバ','イベント班','統括','全員'];

  let selectedYMD = ''; // 日付セル選択
  const holidayCache = new Map(); // key: "YYYY-MM" -> Set(ymd)

  const filters = {
    assignee: '',
    dueTo: '',
    priority: '',
    status: '',
    showDone: false,
    showDiscard: false
  };

  let allTasks = [];
  let selectedRowNumber = null;
  let pendingSave = null;

  const VIEW_KEY = 'task_view_mode';
  let viewMode = (localStorage.getItem(VIEW_KEY) || 'list');

  let calMonth = new Date();
  calMonth.setDate(1);

  function setView(mode){
    viewMode = (mode === 'calendar') ? 'calendar' : 'list';
    localStorage.setItem(VIEW_KEY, viewMode);

    ui.listView.style.display = (viewMode === 'list') ? '' : 'none';
    ui.calView.style.display  = (viewMode === 'calendar') ? '' : 'none';

    ui.btnViewList.classList.toggle('btn-primary', viewMode === 'list');
    ui.btnViewCal.classList.toggle('btn-primary', viewMode === 'calendar');

    ui.btnViewList.classList.toggle('secondary', viewMode !== 'list');
    ui.btnViewCal.classList.toggle('secondary', viewMode !== 'calendar');

    render();
  }

  async function ensureHolidays(year, month1to12){
    const key = `${year}-${String(month1to12).padStart(2,'0')}`;
    if (holidayCache.has(key)) return holidayCache.get(key);

    try{
      const res = await App.callWithTimeout('api_getHolidays', { year, month: month1to12 }, 15000, '祝日取得');
      const set = new Set((res && res.ok && Array.isArray(res.days)) ? res.days : []);
      holidayCache.set(key, set);
      return set;
    }catch(e){
      console.warn('holiday fetch failed', e);
      const set = new Set();
      holidayCache.set(key, set);
      return set;
    }
  }

  function clearSelection(){
    selectedRowNumber = null;
    ui.btnEdit.disabled = true;

    Array.from(ui.list.children).forEach(x=>{
      x.style.outline = '';
      x.style.background = 'rgba(9,13,21,.35)';
    });

    // カレンダー：CSSクラス方式
    ui.calendar.querySelectorAll('.tk-chip').forEach(el=>{
      el.classList.remove('is-selected','is-open');
    });
    ui.noDue.querySelectorAll('.tk-chip').forEach(el=>{
      el.classList.remove('is-selected','is-open');
    });
  }

  // =========
  // Assignee UI
  // =========
  function renderAssigneeCheckboxes(selectedArr){
    const selected = new Set((selectedArr || []).map(x=>String(x).trim()).filter(Boolean));
    ui.i_assigneeBox.innerHTML = '';

    ASSIGNEE_OPTIONS.forEach(name=>{
      const label = document.createElement('label');
      label.style.display='flex';
      label.style.gap='8px';
      label.style.alignItems='center';
      label.innerHTML = `
        <input type="checkbox" data-assignee="${App.escapeHtml(name)}" ${selected.has(name)?'checked':''}>
        <span>${App.escapeHtml(name)}</span>
      `;
      ui.i_assigneeBox.appendChild(label);
    });

    ui.i_assigneeBox.style.gridTemplateColumns = matchMedia('(max-width: 520px)').matches ? '1fr' : '1fr 1fr';
  }

  function getSelectedAssignees(){
    return Array.from(ui.i_assigneeBox.querySelectorAll('input[type="checkbox"][data-assignee]'))
      .filter(ch=>ch.checked)
      .map(ch=>String(ch.dataset.assignee||'').trim())
      .filter(Boolean);
  }

  // =========
  // Filter + Match
  // =========
  function taskMatchesFilter(t){
    const st = String(t.status || '').trim();

    if (!filters.status) {
      if (!filters.showDone && st === '完了') return false;
      if (!filters.showDiscard && st === '破棄') return false;
    }

    if (filters.assignee) {
      const a = String(t.assignee||'');
      if (!a.split(',').map(s=>s.trim()).includes(filters.assignee)) return false;
    }
    if (filters.priority && String(t.priority||'') !== filters.priority) return false;
    if (filters.status && st !== filters.status) return false;

    if (filters.dueTo) {
      const due = time.toYMD(t.due);
      if (due && due > filters.dueTo) return false;
    }
    return true;
  }

  function filteredTasks(){
    return allTasks.filter(taskMatchesFilter);
  }

  // =========
  // List render
  // =========
  function renderList(){
    ui.list.innerHTML = '';
    clearSelection();

    const view = filteredTasks();
    if (view.length === 0){
      const empty = document.createElement('div');
      empty.className = 'notice';
      empty.textContent = '該当するタスクがありません。';
      ui.list.appendChild(empty);
      return;
    }

    view.forEach(t=>{
      const card = document.createElement('div');
      card.dataset.rowNumber = String(t.rowNumber);

      card.style.border = '1px solid var(--line)';
      card.style.borderRadius = '14px';
      card.style.padding = '12px';
      card.style.background = 'rgba(9,13,21,.35)';
      card.style.cursor = 'pointer';

      const due = time.ymdLabel(t.due);
      const chips = [
        t.category && `分類：${t.category}`,
        t.genre && `ジャンル：${t.genre}`,
        t.priority && `優先度：${t.priority}`,
        t.status && `状態：${t.status}`,
        due && `期限：${due}`,
        t.assignee && `担当：${t.assignee}`
      ].filter(Boolean);

      card.innerHTML = `
        <div style="font-size:15px; font-weight:700; line-height:1.5;">
          ${App.escapeHtml(t.task)}
        </div>

        <div style="display:flex; flex-wrap:wrap; gap:6px; margin-top:10px;">
          ${chips.map(c => `
            <span style="font-size:12px; color:var(--muted); padding:6px 8px; border:1px solid var(--line); border-radius:999px;">
              ${App.escapeHtml(c)}
            </span>
          `).join('')}
        </div>

        ${t.note ? `
          <div style="
            margin-top:4px;
            max-width: min(520px, 100%);
            padding:4px 6px;
            border-left:3px solid rgba(255,255,255,.15);
            text-align:left;
            color:var(--muted);
            font-size:11.5px;
            line-height:1.35;
            white-space:pre-wrap;
          ">
            ${App.escapeHtml(t.note)}
          </div>
        ` : ''}
      `;

      card.onclick = ()=>{
        Array.from(ui.list.children).forEach(x=>{
          x.style.outline = '';
          x.style.background = 'rgba(9,13,21,.35)';
        });
        card.style.outline = '2px solid rgba(78,161,255,.55)';
        card.style.background = 'rgba(78,161,255,.08)';

        selectedRowNumber = t.rowNumber;
        ui.btnEdit.disabled = false;
      };

      ui.list.appendChild(card);
    });
  }

  // =========
  // Calendar render (Grid)
  // =========
  function buildTaskTipHtml(t){
    const due = time.toYMD(t.due) || '';
    const lines = [
      `<div style="font-weight:700; margin-bottom:4px;">${App.escapeHtml(t.task || '')}</div>`,
      `<div style="color:var(--muted); font-size:11px;">` +
      `${App.escapeHtml([
        t.status ? `状態：${t.status}` : '',
        t.priority ? `優先度：${t.priority}` : '',
        t.assignee ? `担当：${t.assignee}` : '',
        due ? `期限：${due}` : ''
      ].filter(Boolean).join(' / '))}` +
      `</div>`,
      t.note ? `<div style="margin-top:6px; font-size:11px; color:var(--muted); white-space:pre-wrap;">${App.escapeHtml(t.note)}</div>` : ''
    ];
    return lines.join('');
  }

  // 外側タップで tooltip を閉じる（スマホ）
  if (!window.__TK_OUTSIDE_CLOSE__) {
    window.__TK_OUTSIDE_CLOSE__ = true;
    document.addEventListener('click', ()=>{
      document.querySelectorAll('.tk-chip.is-open').forEach(el=>el.classList.remove('is-open'));
    }, true);
  }

  function renderCalendar(){
    clearSelection();

    // weekday header（月曜始まり）
    const wds = ['月','火','水','木','金','土','日'];
    ui.calWeekdays.innerHTML = wds.map((x, i)=>{
      const color = (i === 5) ? 'var(--accent)' : (i === 6 ? 'var(--danger)' : 'var(--muted)');
      return `<div style="text-align:center; padding:4px 0; color:${color};">${x}</div>`;
    }).join('');

    const y = calMonth.getFullYear();
    const m0 = calMonth.getMonth(); // 0-based
    const m1 = m0 + 1;
    ui.calTitle.textContent = `${y}年${m1}月`;

    const firstDay = new Date(y, m0, 1);
    const startDowSun0 = firstDay.getDay();          // 0=日..6=土
    const startDowMon0 = (startDowSun0 + 6) % 7;     // 0=月..6=日
    const daysInMonth = new Date(y, m0+1, 0).getDate();

    const monthKey = `${y}-${String(m1).padStart(2,'0')}`;
    const holidays = holidayCache.get(monthKey) || new Set();

    // tasks grouped by due ymd
    const byDay = new Map();
    const noDue = [];

    filteredTasks().forEach(t=>{
      const ymd = time.toYMD(t.due);
      if (!ymd) { noDue.push(t); return; }
      const d = time.ymdToDate(ymd);
      if (!d) { noDue.push(t); return; }
      if (d.getFullYear() === y && d.getMonth() === m0){
        if (!byDay.has(ymd)) byDay.set(ymd, []);
        byDay.get(ymd).push(t);
      }
    });

    ui.calendar.innerHTML = '';

    // ====== helpers ======
    function closeAllChips(){
      ui.calendar.querySelectorAll('.tk-chip').forEach(c=> c.classList.remove('is-open'));
      ui.noDue.querySelectorAll('.tk-chip').forEach(c=> c.classList.remove('is-open'));
    }

    function clearChipSelection(){
      ui.calendar.querySelectorAll('.tk-chip').forEach(c=> c.classList.remove('is-selected'));
      ui.noDue.querySelectorAll('.tk-chip').forEach(c=> c.classList.remove('is-selected'));
      selectedRowNumber = null;
      ui.btnEdit.disabled = true;
    }

    function selectChip(chipEl, rowNumber){
      // 選択は常に一つ
      ui.calendar.querySelectorAll('.tk-chip').forEach(c=> c.classList.remove('is-selected'));
      ui.noDue.querySelectorAll('.tk-chip').forEach(c=> c.classList.remove('is-selected'));

      chipEl.classList.add('is-selected');
      selectedRowNumber = rowNumber;
      ui.btnEdit.disabled = false;
    }

    // スマホ：外側タップで tooltip 閉じる（選択は維持）
    // ※毎回 renderCalendar で再バインドされるのを避けるため、フラグでガード
    if (!window.__TK_CAL_OUTSIDE_CLOSE_BOUND__){
      window.__TK_CAL_OUTSIDE_CLOSE_BOUND__ = true;
      document.addEventListener('pointerdown', (e)=>{
        if (!matchMedia('(hover: none)').matches) return; // touchのみ
        const chip = e.target.closest('.tk-chip');
        if (chip) return; // チップ内なら閉じない
        closeAllChips();
      }, true);
    }

    // leading blanks（先頭だけ）
    for(let i=0;i<startDowMon0;i++){
      const blank = document.createElement('div');
      blank.className = 'tk-cal-blank';
      ui.calendar.appendChild(blank);
    }

    const todayYMD = time.toYMD(new Date());

    for(let day=1; day<=daysInMonth; day++){
      const ymd = `${y}-${String(m1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;

      const dowSun0 = new Date(y, m0, day).getDay(); // 0=日..6=土
      const isHoliday = holidays.has(ymd);
      const isSun = (dowSun0 === 0);
      const isSat = (dowSun0 === 6);

      let dayColor = '';
      if (isHoliday || isSun) dayColor = 'var(--danger)';
      else if (isSat) dayColor = 'var(--accent)';

      const cell = document.createElement('div');
      cell.className = 'tk-cal-cell';
      cell.dataset.ymd = ymd;

      // 今日ハイライト（薄く）
      if (ymd === todayYMD) {
        cell.style.boxShadow = '0 0 0 2px rgba(78,161,255,.18) inset';
      }

      cell.innerHTML = `
        <div style="display:flex; align-items:center; justify-content:space-between; gap:6px;">
          <div style="font-weight:800; font-size:13px; ${dayColor ? `color:${dayColor};` : ''}">
            ${day}
          </div>
        </div>
        <div style="display:grid; gap:${isSp ? '2px' : '4px'}; margin-top:${isSp ? '2px' : '6px'};" data-slot="tasks"></div>
      `;

      // 日付セルの選択（chipは stopPropagation するので邪魔しない）
      cell.addEventListener('click', ()=>{
        selectedYMD = ymd;

        // 日付枠の引き直し
        ui.calendar.querySelectorAll('[data-ymd]').forEach(x=>{ x.style.outline = ''; });
        cell.style.outline = '2px solid rgba(78,161,255,.55)';
      });

      const slot = cell.querySelector('[data-slot="tasks"]');
      const tasks = byDay.get(ymd) || [];

      const maxShow = isSp ? 4 : 3;
      const show = tasks.slice(0, maxShow);

      show.forEach(t=>{
        // ===== CSS tooltip 方式のチップ =====
        const chipWrap = document.createElement('div');
        chipWrap.className = 'tk-chip';
        chipWrap.dataset.row = String(t.rowNumber);

        chipWrap.innerHTML = `
          <div class="tk-chip-label">${App.escapeHtml(t.task || '')}</div>
          <div class="tk-tooltip">${buildTaskTipHtml(t)}</div>
        `;

        // ✅ 選択（PC/SP共通）
        chipWrap.addEventListener('click', (ev)=>{
          ev.stopPropagation();        // 日付セル選択させない
          closeAllChips();             // まず他を閉じる（選択はこの後）

          selectChip(chipWrap, t.rowNumber);

          // SPだけ tooltip を開く（閉じるのは外側タップ or 同じチップ再タップ）
          if (isTouch){
            chipWrap.classList.add('is-open');
          }
        });

        // ✅ SP：同じチップをもう一度タップで tooltip を閉じる（選択は維持）
        if (isTouch){
          chipWrap.addEventListener('pointerdown', (ev)=>{
            // click より前に動くので、開閉だけ処理して click に任せる
            const alreadySelected = chipWrap.classList.contains('is-selected');
            const alreadyOpen = chipWrap.classList.contains('is-open');

            // 既に選択済み＆開いているなら「閉じる」だけして click で再オープンしないよう抑止
            if (alreadySelected && alreadyOpen){
              ev.preventDefault();     // 合成click抑止（iOS対策）
              ev.stopPropagation();
              chipWrap.classList.remove('is-open');
            }
          }, { passive:false });
        }

        slot.appendChild(chipWrap);
      });

      if (tasks.length > maxShow){
        const more = document.createElement('div');
        more.style.fontSize = '11px';
        more.style.color = 'var(--muted)';
        more.style.padding = isSp ? '2px 2px 0' : '0';
        more.textContent = `他 ${tasks.length - maxShow} 件`;
        slot.appendChild(more);
      }

      ui.calendar.appendChild(cell);
    }

    // 期限なし
    ui.noDue.innerHTML = '';
    if(noDue.length === 0){
      const empty = document.createElement('div');
      empty.className = 'notice';
      empty.textContent = '期限なしのタスクはありません。';
      ui.noDue.appendChild(empty);
    }else{
      noDue.forEach(t=>{
        // ✅ 一覧表示と同じ見た目（tooltip無し）
        const card = document.createElement('div');
        card.dataset.row = String(t.rowNumber);

        card.style.border = '1px solid var(--line)';
        card.style.borderRadius = '14px';
        card.style.padding = '12px';
        card.style.background = 'rgba(9,13,21,.35)';
        card.style.cursor = 'pointer';

        const due = time.ymdLabel(t.due); // 期限なしなら空の想定
        const chips = [
          t.category && `分類：${t.category}`,
          t.genre && `ジャンル：${t.genre}`,
          t.priority && `優先度：${t.priority}`,
          t.status && `状態：${t.status}`,
          due && `期限：${due}`,
          t.assignee && `担当：${t.assignee}`
        ].filter(Boolean);

        card.innerHTML = `
          <div style="font-size:15px; font-weight:700; line-height:1.5;">
            ${App.escapeHtml(t.task)}
          </div>

          <div style="display:flex; flex-wrap:wrap; gap:6px; margin-top:10px;">
            ${chips.map(c => `
              <span style="font-size:12px; color:var(--muted); padding:6px 8px; border:1px solid var(--line); border-radius:999px;">
                ${App.escapeHtml(c)}
              </span>
            `).join('')}
          </div>

          ${t.note ? `
            <div style="
              margin-top:4px;
              max-width: min(520px, 100%);
              padding:4px 6px;
              border-left:3px solid rgba(255,255,255,.15);
              text-align:left;
              color:var(--muted);
              font-size:11.5px;
              line-height:1.35;
              white-space:pre-wrap;
            ">
              ${App.escapeHtml(t.note)}
            </div>
          ` : ''}
        `;

        // ✅ 選択して「修正」へ行けるように（カレンダーと同じ選択ロジック）
        card.addEventListener('click', ()=>{
          // 期限なしカード内の選択解除
          ui.noDue.querySelectorAll('[data-row]').forEach(el=>{
            el.style.outline = '';
            el.style.background = 'rgba(9,13,21,.35)';
          });
          // カレンダーチップ側の選択解除
          ui.calendar.querySelectorAll('.tk-chip').forEach(c=> c.classList.remove('is-selected','is-open'));

          card.style.outline = '2px solid rgba(78,161,255,.55)';
          card.style.background = 'rgba(78,161,255,.08)';
          selectedRowNumber = t.rowNumber;
          ui.btnEdit.disabled = false;
        });

        ui.noDue.appendChild(card);
      });
    }
  }

  async function render(){
    if(viewMode === 'calendar'){
      const y = calMonth.getFullYear();
      const m1 = calMonth.getMonth() + 1;
      await ensureHolidays(y, m1);
      renderCalendar();
    }else{
      renderList();
    }
  }

  // ===== 入力補助（blur）=====
  function showFieldWarn(inputEl, msg){
    const id = inputEl.id + '_warn';
    let w = document.getElementById(id);
    if(!w){
      w = document.createElement('div');
      w.id = id;
      w.style.marginTop = '6px';
      w.style.fontSize = '12px';
      w.style.color = '#ffb4b4';
      inputEl.parentElement.appendChild(w);
    }
    w.textContent = msg || '';
    inputEl.style.borderColor = msg ? 'rgba(255,120,120,.75)' : '';
  }
  function clearFieldWarn(inputEl){ showFieldWarn(inputEl,''); }
  function bindBasicFieldBehaviors(){
    const task = ui.i_task;
    if(!task) return;
    task.onblur = () => {
      const v = (task.value || '').trim();
      if(!v) showFieldWarn(task,'タスク内容は必須です。');
      else clearFieldWarn(task);
    };
  }

  // =========
  // Server
  // =========
  async function loadTasks(){
    setStatus('タスク一覧を読み込み中...', true);
    try{
      const res = await App.callWithTimeout('api_getTasks', {}, 15000, '取得');
      if(!res.ok) throw new Error(res.message || '取得に失敗しました');

      allTasks = res.tasks || [];

      const set = new Set(ASSIGNEE_OPTIONS);
      allTasks.forEach(t=>{
        String(t.assignee||'').split(',').map(x=>x.trim()).filter(Boolean).forEach(x=>set.add(x));
      });
      const options = Array.from(set)
        .map(x=>`<option value="${App.escapeHtml(x)}">${App.escapeHtml(x)}</option>`)
        .join('');
      ui.f_assignee.innerHTML = `<option value="">（指定なし）</option>${options}`;

      await render();
      setStatus('読み込み完了。', false);
    }catch(e){
      console.error(e);
      setStatus('読み込みに失敗しました：' + (e.message||e), false);
      App.modal?.error('読み込みに失敗しました：' + (e.message||e));
    }
  }

  // =========
  // Filter modal
  // =========
  function openFilter(){
    ui.f_assignee.value = filters.assignee || '';
    ui.f_dueTo.value = filters.dueTo || '';
    ui.f_priority.value = filters.priority || '';
    ui.f_status.value = filters.status || '';
    ui.f_showDone.checked = !!filters.showDone;
    ui.f_showDiscard.checked = !!filters.showDiscard;
    modal.open(ui.filterModal);
  }
  function closeFilter(){ modal.close(ui.filterModal); }

  function applyFilterFromUI(){
    filters.assignee = ui.f_assignee.value || '';
    filters.dueTo = ui.f_dueTo.value || '';
    filters.priority = ui.f_priority.value || '';
    filters.status = ui.f_status.value || '';
    filters.showDone = !!ui.f_showDone.checked;
    filters.showDiscard = !!ui.f_showDiscard.checked;
    render();
    setStatus('絞り込みを適用しました。', false);
  }

  function clearFilter(){
    Object.assign(filters, {
      assignee:'', dueTo:'', priority:'', status:'',
      showDone:false, showDiscard:false
    });
    ui.f_assignee.value = '';
    ui.f_dueTo.value = '';
    ui.f_priority.value = '';
    ui.f_status.value = '';
    ui.f_showDone.checked = false;
    ui.f_showDiscard.checked = false;
    render();
    setStatus('絞り込みをクリアしました。', false);
  }

  // =========
  // Edit modal
  // =========
  function openEdit(mode, taskObj){
    modal.open(ui.editModal);

    ui.editTitle.textContent = (mode === 'edit') ? 'タスク修正' : 'タスク追加';
    ui.i_save.textContent = '登録';

    ui.i_task.value = taskObj?.task || '';
    ui.i_category.value = taskObj?.category || '';
    ui.i_genre.value = taskObj?.genre || '';
    ui.i_due.value = taskObj?.due ? time.toYMD(taskObj.due) : (taskObj?.due || '');
    ui.i_priority.value = taskObj?.priority || '';
    ui.i_status.value = taskObj?.status || '';
    ui.i_note.value = taskObj?.note || '';
    renderAssigneeCheckboxes(String(taskObj?.assignee||'').split(',').map(x=>x.trim()).filter(Boolean));

    ui.editModal.dataset.mode = mode;
    ui.editModal.dataset.rowNumber = taskObj?.rowNumber ? String(taskObj.rowNumber) : '';
  }

  function closeEdit(){
    modal.close(ui.editModal);
    clearFieldWarn(ui.i_task);
  }

  function getEditData(){
    return {
      task: ui.i_task.value,
      category: ui.i_category.value,
      genre: ui.i_genre.value,
      assignee: getSelectedAssignees(),
      due: ui.i_due.value || null,
      priority: ui.i_priority.value,
      status: ui.i_status.value,
      note: ui.i_note.value
    };
  }

  function validateEditData(data){
    if(!(data.task || '').trim()) return 'タスク内容は必須です。';
    return null;
  }

  function buildConfirmText(data, mode){
    const title = (mode === 'edit') ? '【修正】' : '【追加】';
    const asg = (data.assignee || []).join(', ');
    return [
      `${title}`,
      `タスク内容：${data.task || ''}`,
      `分類：${data.category || ''}`,
      `ジャンル：${data.genre || ''}`,
      `担当：${asg}`,
      `期限：${data.due || ''}`,
      `優先度：${data.priority || ''}`,
      `ステータス：${data.status || ''}`,
      `備考：${data.note || ''}`,
    ].join('\n');
  }

  async function performSave(p){
    setStatus((p.mode==='edit') ? '更新中...' : '追加中...', true);
    busy.show();

    try{
      const res = await App.callWithTimeout('api_upsertTask', {
        mode: p.mode,
        rowNumber: p.rowNumber,
        data: p.data
      }, 30000, '保存');

      if(!res.ok) throw new Error(res.message || '保存に失敗しました');

      await loadTasks();

      busy.hide();
      closeEdit();

      App.modal?.info(p.mode === 'edit' ? '更新しました' : '追加しました');
      setStatus('完了しました。', false);

    } catch(e){
      console.error(e);
      busy.hide();
      setStatus('保存に失敗しました：' + (e.message||e), false);
      App.modal?.error('保存に失敗しました：' + (e.message||e));
    }
  }

  // =========
  // Events
  // =========
  ui.btnFilter.onclick = openFilter;

  ui.btnAdd.onclick = ()=>{
    const preset = selectedYMD ? { due: selectedYMD } : null;
    openEdit('create', preset);
  };

  ui.btnEdit.onclick = ()=>{
    if(!selectedRowNumber) return;
    const t = allTasks.find(x=>x.rowNumber === selectedRowNumber);
    if(!t) return App.modal?.warn('選択行が見つかりません。再読み込みしてください。');
    openEdit('edit', t);
  };

  ui.f_apply.onclick = ()=>{ applyFilterFromUI(); closeFilter(); };
  ui.f_clear.onclick = clearFilter;
  ui.f_close.onclick = closeFilter;

  ui.i_cancel.onclick = ()=>{ closeEdit(); };

  ui.i_save.onclick = ()=>{
    const mode = ui.editModal.dataset.mode || 'create';
    const rowNumber = Number(ui.editModal.dataset.rowNumber || NaN);
    const data = getEditData();

    const err = validateEditData(data);
    if(err) return App.modal?.warn(err);

    pendingSave = { mode, rowNumber, data };
    (async ()=>{
      const ok = await App.modal?.confirm(buildConfirmText(data, mode), {
        title: 'この内容で登録します。よろしいですか？',
        okText: 'はい',
        cancelText: 'いいえ'
      });
      if(!ok) return;
      await performSave(pendingSave);
      pendingSave = null;
    })();
  };

  ui.btnViewList.onclick = ()=> setView('list');
  ui.btnViewCal.onclick  = ()=> setView('calendar');

  ui.calPrev.onclick = async ()=>{
    App.busy?.show('カレンダーを読み込んでいます。\nしばらくお待ちください。', { title: '読み込み中...' });
    try{
      calMonth = new Date(calMonth.getFullYear(), calMonth.getMonth()-1, 1);
      await render();
    }finally{
      App.busy?.hide();
    }
  };

  ui.calNext.onclick = async ()=>{
    App.busy?.show('カレンダーを読み込んでいます。\nしばらくお待ちください。', { title: '読み込み中...' });
    try{
      calMonth = new Date(calMonth.getFullYear(), calMonth.getMonth()+1, 1);
      await render();
    }finally{
      App.busy?.hide();
    }
  };

  ui.calToday.onclick = async ()=>{
    App.busy?.show('カレンダーを読み込んでいます。\nしばらくお待ちください。', { title: '読み込み中...' });
    try{
      calMonth = new Date();
      calMonth.setDate(1);
      await render();
    }finally{
      App.busy?.hide();
    }
  };

  // resize: assignee box columns
  if (window.__TASK_RESIZE_HANDLER__) window.removeEventListener('resize', window.__TASK_RESIZE_HANDLER__);
  window.__TASK_RESIZE_HANDLER__ = ()=>{
    if(ui.editModal.style.display === 'block'){
      ui.i_assigneeBox.style.gridTemplateColumns = matchMedia('(max-width: 520px)').matches ? '1fr' : '1fr 1fr';
    }
  };
  window.addEventListener('resize', window.__TASK_RESIZE_HANDLER__);

  // =========
  // Start
  // =========
  setView(viewMode);
  loadTasks();
  bindBasicFieldBehaviors();
};
</script>
