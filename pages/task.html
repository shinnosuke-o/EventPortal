<section class="card">
  <h1>タスク管理</h1>
  <div class="notice" id="tk_status">読み込み中...</div>
</section>

<section class="card">
  <div class="btn-row"
       style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
    <button id="tk_filterBtn" class="btn secondary">絞り込み</button>
    <!-- ★右寄せ用のスペーサ -->
    <div style="flex:1 1 auto;"></div>
    <button id="tk_addBtn" class="btn">追加</button>
    <button id="tk_editBtn" class="btn" disabled>修正</button>
  </div>
</section>

<section class="card">
  <h2>タスク一覧</h2>
  <div class="notice" style="margin-top:10px;">
    カードをタップ/クリックで選択できます（修正ボタンが有効になります）。
  </div>
  <div id="tk_list" style="display:grid; gap:10px; margin-top:12px;"></div>
</section>


<!-- 絞り込みモーダル -->
<div id="tk_filterModal" style="display:none; position:fixed; inset:0; z-index:10035; background:rgba(0,0,0,.55);">
  <div style="max-width:560px; margin:10vh auto; padding:14px; border-radius:16px; border:1px solid var(--line); background:rgba(18,26,39,.98);">
    <h2 style="margin:0 0 10px;">絞り込み</h2>

    <div class="grid" style="grid-template-columns:1fr 1fr;">
      <div class="field">
        <div class="label">担当</div>
        <select id="tk_f_assignee">
          <option value="">（指定なし）</option>
        </select>
      </div>

      <div class="field">
        <div class="label">期限（〜まで）</div>
        <input id="tk_f_dueTo" type="date">
      </div>

      <div class="field">
        <div class="label">優先度</div>
        <select id="tk_f_priority">
          <option value="">（指定なし）</option>
          <option value="高">高</option>
          <option value="中">中</option>
          <option value="低">低</option>
        </select>
      </div>

      <div class="field">
        <div class="label">ステータス</div>
        <select id="tk_f_status">
          <option value="">（指定なし）</option>
          <option value="未着手">未着手</option>
          <option value="進行中">進行中</option>
          <option value="確認中">確認中</option>
          <option value="完了">完了</option>
          <option value="破棄">破棄</option>
        </select>
      </div>
      <div class="field" style="grid-column:1 / -1;">
        <div class="label">表示オプション</div>

        <div style="
          display:flex;
          gap:14px;
          flex-wrap:wrap;
          padding:10px;
          border:1px solid var(--line);
          border-radius:12px;
          background:rgba(9,13,21,.35);
        ">
          <label style="display:flex; gap:8px; align-items:center;">
            <input type="checkbox" id="tk_f_showDone">
            <span>完了も表示</span>
          </label>

          <label style="display:flex; gap:8px; align-items:center;">
            <input type="checkbox" id="tk_f_showDiscard">
            <span>破棄も表示</span>
          </label>
        </div>
      </div>    
    </div>

    <div class="btn-row" style="margin-top:14px; justify-content:flex-end; gap:10px;">
      <button id="tk_f_clear" class="btn secondary">クリア</button>
      <button id="tk_f_close" class="btn secondary">閉じる</button>
      <button id="tk_f_apply" class="btn btn-primary">適用</button>
    </div>
  </div>
</div>

<!-- 追加/修正モーダル -->
<div id="tk_editModal" style="display:none; position:fixed; inset:0; z-index:10035; background:rgba(0,0,0,.55);">
  <div style="height:100%; display:flex; align-items:flex-start; justify-content:center; padding:12px;">
    <div style="
      width:min(720px, 100%);
      max-height:calc(100dvh - 24px);
      border-radius:16px;
      border:1px solid var(--line);
      background:rgba(18,26,39,.98);
      display:flex;
      flex-direction:column;
      overflow:hidden;
    ">
      <!-- ヘッダ固定 -->
      <div style="padding:14px; border-bottom:1px solid var(--line);">
        <h2 id="tk_editTitle" style="margin:0;">タスク追加</h2>
      </div>

      <!-- ここがスクロール領域 -->
      <div style="padding:14px; overflow:auto; -webkit-overflow-scrolling:touch;">
        <div class="grid" style="grid-template-columns:1fr 1fr;">
          <div class="field" style="grid-column:1 / -1;">
            <div class="label">タスク内容（必須）</div>
            <input id="tk_i_task" placeholder="例：演出シート提出">
          </div>

          <div class="field">
            <div class="label">分類</div>
            <select id="tk_i_category">
              <option value="">（未選択）</option>
              <option value="イベント">イベント</option>
              <option value="統括">統括</option>
              <option value="全体">全体</option>
            </select>
          </div>

          <div class="field">
            <div class="label">ジャンル</div>
            <select id="tk_i_genre">
              <option value="">（未選択）</option>
              <option value="お祭り準備">お祭り準備</option>
              <option value="提出物">提出物</option>
              <option value="スケジュール">スケジュール</option>
              <option value="フォーム">フォーム</option>
              <option value="SNS">SNS</option>
              <option value="スタッフ">スタッフ</option>
              <option value="限定">限定</option>
            </select>
          </div>

          <div class="field">
            <div class="label">担当（複数選択可）</div>
            <div id="tk_i_assigneeBox" style="display:grid; grid-template-columns:1fr 1fr; gap:8px; padding:10px; border:1px solid var(--line); border-radius:12px; background:rgba(9,13,21,.35);">
              <!-- JSでチェックボックス生成 -->
            </div>
          </div>

          <div class="field">
            <div class="label">期限</div>
            <input id="tk_i_due" type="date">
          </div>

          <div class="field">
            <div class="label">優先度</div>
            <select id="tk_i_priority">
              <option value="">（未選択）</option>
              <option value="高">高</option>
              <option value="中">中</option>
              <option value="低">低</option>
            </select>
          </div>

          <div class="field">
            <div class="label">ステータス</div>
            <select id="tk_i_status">
              <option value="">（未選択）</option>
              <option value="未着手">未着手</option>
              <option value="進行中">進行中</option>
              <option value="確認中">確認中</option>
              <option value="完了">完了</option>
              <option value="破棄">破棄</option>
            </select>
          </div>

          <div class="field" style="grid-column:1 / -1;">
            <div class="label">備考</div>
            <textarea id="tk_i_note" rows="3" placeholder="補足があれば"></textarea>
          </div>
        </div>
      </div>

      <!-- フッタ固定 -->
      <div class="btn-row" style="padding:14px; border-top:1px solid var(--line); justify-content:flex-end; gap:10px;">
        <button id="tk_i_cancel" class="btn secondary">閉じる</button>
        <button id="tk_i_save" class="btn btn-primary">登録</button>
      </div>
    </div>
  </div>
</div>

<script>
window.taskInit = function taskInit(){
  const $ = (s)=>document.querySelector(s);
  const App = window.App || {};

  // =========
  // DOM
  // =========
  const ui = {
    status: $('#tk_status'),
    list: $('#tk_list'),

    // toolbar
    btnFilter: $('#tk_filterBtn'),
    btnAdd: $('#tk_addBtn'),
    btnEdit: $('#tk_editBtn'),

    // filter modal
    filterModal: $('#tk_filterModal'),
    f_assignee: $('#tk_f_assignee'),
    f_dueTo: $('#tk_f_dueTo'),
    f_priority: $('#tk_f_priority'),
    f_status: $('#tk_f_status'),
    f_showDone: $('#tk_f_showDone'),
    f_showDiscard: $('#tk_f_showDiscard'),
    f_apply: $('#tk_f_apply'),
    f_close: $('#tk_f_close'),
    f_clear: $('#tk_f_clear'),

    // edit modal
    editModal: $('#tk_editModal'),
    editTitle: $('#tk_editTitle'),
    i_task: $('#tk_i_task'),
    i_category: $('#tk_i_category'),
    i_genre: $('#tk_i_genre'),
    i_assigneeBox: $('#tk_i_assigneeBox'),
    i_due: $('#tk_i_due'),
    i_priority: $('#tk_i_priority'),
    i_status: $('#tk_i_status'),
    i_note: $('#tk_i_note'),
    i_cancel: $('#tk_i_cancel'),
    i_save: $('#tk_i_save'),

    // confirm/busy are handled by shared App modal
  };

  // 必須DOM確認
  const required = [
    ui.status, ui.list, ui.btnFilter, ui.btnAdd, ui.btnEdit,
    ui.filterModal, ui.editModal,
    ui.f_showDone, ui.f_showDiscard
  ];
  if (required.some(x => !x)) return;

  // 多重初期化防止
  if (ui.list.dataset.inited === '1') return;
  ui.list.dataset.inited = '1';

  // =========
  // Helpers
  // =========
  function setStatus(text, busy){
    if (App.setStatus) return App.setStatus(ui.status, text, busy);
    ui.status.textContent = text;
    ui.status.style.borderColor = busy ? 'rgba(78,161,255,.55)' : 'var(--line)';
  }

  function escapeHtml(s){
    return App.escapeHtml
      ? App.escapeHtml(s)
      : (s ?? '').toString()
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'","&#039;");
  }

  const time = {
    toYMD(v){
      if (!v) return '';
      const d = new Date(v);
      if (isNaN(d.getTime())) return '';
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const day = String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${day}`;
    },
    ymdLabel(v){
      const ymd = time.toYMD(v);
      if(!ymd) return '';
      const [,m,d] = ymd.split('-');
      return `${Number(m)}/${Number(d)}`;
    }
  };

  const modal = {
    open(el){
      if(!el) return;
      el.style.display = 'block';
    },
    close(el){
      if(!el) return;
      el.style.display = 'none';
    }
  };

  const busy = {
    show(){
      if (App.busy) return App.busy.show('タスクを登録してます。\nしばらくお待ちください。', { title: '登録中です…' });
    },
    hide(){
      if (App.busy) return App.busy.hide();
    }
  };

  function setBodyScrollLock(lock){
    if (App.toggleBodyScroll) App.toggleBodyScroll(lock);
    else document.body.style.overflow = lock ? 'hidden' : '';
  }

  // =========
  // State
  // =========
  const ASSIGNEE_OPTIONS = ['けいちゃん','キム','小澤','いおり','ジョバ','イベント班','統括','全員'];

  const filters = {
    assignee: '',
    dueTo: '',
    priority: '',
    status: '',
    showDone: false,
    showDiscard: false
  };

  let allTasks = [];
  let selectedRowNumber = null;
  let pendingSave = null; // { mode, rowNumber, data }

  // =========
  // Assignee UI
  // =========
  function renderAssigneeCheckboxes(selectedArr){
    const selected = new Set((selectedArr || []).map(x=>String(x).trim()).filter(Boolean));
    ui.i_assigneeBox.innerHTML = '';

    ASSIGNEE_OPTIONS.forEach(name=>{
      const label = document.createElement('label');
      label.style.display='flex';
      label.style.gap='8px';
      label.style.alignItems='center';
      label.innerHTML = `
        <input type="checkbox" data-assignee="${escapeHtml(name)}" ${selected.has(name)?'checked':''}>
        <span>${escapeHtml(name)}</span>
      `;
      ui.i_assigneeBox.appendChild(label);
    });

    if (window.matchMedia('(max-width: 520px)').matches) {
      ui.i_assigneeBox.style.gridTemplateColumns = '1fr';
    } else {
      ui.i_assigneeBox.style.gridTemplateColumns = '1fr 1fr';
    }
  }

  function getSelectedAssignees(){
    return Array.from(ui.i_assigneeBox.querySelectorAll('input[type="checkbox"][data-assignee]'))
      .filter(ch=>ch.checked)
      .map(ch=>String(ch.dataset.assignee||'').trim())
      .filter(Boolean);
  }

  // =========
  // Filter + Render
  // =========
  function taskMatchesFilter(t){
    const st = String(t.status || '').trim();

    // デフォルト：完了・破棄を非表示（ただしステータス指定時はそちら優先）
    if (!filters.status) {
      if (!filters.showDone && st === '完了') return false;
      if (!filters.showDiscard && st === '破棄') return false;
    }

    if (filters.assignee) {
      const a = String(t.assignee||'');
      if (!a.split(',').map(s=>s.trim()).includes(filters.assignee)) return false;
    }
    if (filters.priority && String(t.priority||'') !== filters.priority) return false;
    if (filters.status && st !== filters.status) return false;

    if (filters.dueTo) {
      const due = time.toYMD(t.due);
      if (due && due > filters.dueTo) return false;
    }

    return true;
  }

  function clearSelection(){
    selectedRowNumber = null;
    ui.btnEdit.disabled = true;
  }

  function renderCards(){
    ui.list.innerHTML = '';
    clearSelection();

    const view = allTasks.filter(taskMatchesFilter);

    if (view.length === 0){
      const empty = document.createElement('div');
      empty.className = 'notice';
      empty.textContent = '該当するタスクがありません。';
      ui.list.appendChild(empty);
      return;
    }

    view.forEach(t=>{
      const card = document.createElement('div');
      card.dataset.rowNumber = String(t.rowNumber);

      card.style.border = '1px solid var(--line)';
      card.style.borderRadius = '14px';
      card.style.padding = '12px';
      card.style.background = 'rgba(9,13,21,.35)';
      card.style.cursor = 'pointer';

      const due = time.ymdLabel(t.due);
      const chips = [
        t.category && `分類：${t.category}`,
        t.genre && `ジャンル：${t.genre}`,
        t.priority && `優先度：${t.priority}`,
        t.status && `状態：${t.status}`,
        due && `期限：${due}`,
        t.assignee && `担当：${t.assignee}`
      ].filter(Boolean);

      card.innerHTML = `
        <div style="font-size:15px; font-weight:700; line-height:1.5;">
          ${escapeHtml(t.task)}
        </div>

        <div style="display:flex; flex-wrap:wrap; gap:6px; margin-top:10px;">
          ${chips.map(c => `
            <span style="font-size:12px; color:var(--muted); padding:6px 8px; border:1px solid var(--line); border-radius:999px;">
              ${escapeHtml(c)}
            </span>
          `).join('')}
        </div>

        ${t.note ? `
          <div style="
            margin-top:4px;
            max-width: min(520px, 100%);
            padding:4px 6px;
            border-left:3px solid rgba(255,255,255,.15);
            text-align:left;
            color:var(--muted);
            font-size:11.5px;
            line-height:1.35;
            white-space:pre-wrap;
          ">
            ${escapeHtml(t.note)}
          </div>
        ` : ''}
      `;

      card.onclick = ()=>{
        // 選択UI
        Array.from(ui.list.children).forEach(x=>{
          x.style.outline = '';
          x.style.background = 'rgba(9,13,21,.35)';
        });
        card.style.outline = '2px solid rgba(78,161,255,.55)';
        card.style.background = 'rgba(78,161,255,.08)';

        selectedRowNumber = t.rowNumber;
        ui.btnEdit.disabled = false;
      };

      ui.list.appendChild(card);
    });
  }

  // ===== 入力補助（blur）=====
  function showFieldWarn(inputEl, msg){
    const id = inputEl.id + '_warn';
    let w = document.getElementById(id);
    if(!w){
      w = document.createElement('div');
      w.id = id;
      w.style.marginTop = '6px';
      w.style.fontSize = '12px';
      w.style.color = '#ffb4b4';
      inputEl.parentElement.appendChild(w);
    }
    w.textContent = msg || '';
    inputEl.style.borderColor = msg ? 'rgba(255,120,120,.75)' : '';
  }
  function clearFieldWarn(inputEl){ showFieldWarn(inputEl,''); }

  function bindBasicFieldBehaviors(){
    const task = tk_i_task;

    if(!task) return;

    task.onblur = () => {
      const v = (task.value || '').trim();
      if(!v) showFieldWarn(task,'タスク内容は必須です。');
      else clearFieldWarn(task);
    };
  }

  // =========
  // Server
  // =========
  async function callWithTimeout(fn, payload, ms, label){
    if (App.callWithTimeout) return App.callWithTimeout(fn, payload, ms, label);
    const res = await Promise.race([
      callServer(fn, payload),
      new Promise((_, reject)=> setTimeout(()=> reject(new Error(label ? `タイムアウト（${Math.ceil(ms/1000)}秒）：${label}` : `タイムアウト（${Math.ceil(ms/1000)}秒）`)), ms))
    ]);
    if(!res) throw new Error(`${label || fn}：サーバー応答が空です（null）`);
    return res;
  }

  async function loadTasks(){
    setStatus('タスク一覧を読み込み中...', true);
    try{
      const res = await callWithTimeout('api_getTasks', {}, 15000, '取得');
      if(!res.ok) throw new Error(res.message || '取得に失敗しました');

      allTasks = res.tasks || [];

      // 担当候補を更新
      const set = new Set(ASSIGNEE_OPTIONS);
      allTasks.forEach(t=>{
        String(t.assignee||'').split(',').map(x=>x.trim()).filter(Boolean).forEach(x=>set.add(x));
      });
      const options = Array.from(set)
        .map(x=>`<option value="${escapeHtml(x)}">${escapeHtml(x)}</option>`)
        .join('');
      ui.f_assignee.innerHTML = `<option value="">（指定なし）</option>${options}`;

      renderCards();
      setStatus('読み込み完了。', false);
    }catch(e){
      console.error(e);
      setStatus('読み込みに失敗しました：' + (e.message||e), false);
      App.modal?.error('読み込みに失敗しました：' + (e.message||e));
    }
  }

  // =========
  // Filter modal
  // =========
  function openFilter(){
    ui.f_assignee.value = filters.assignee || '';
    ui.f_dueTo.value = filters.dueTo || '';
    ui.f_priority.value = filters.priority || '';
    ui.f_status.value = filters.status || '';
    ui.f_showDone.checked = !!filters.showDone;
    ui.f_showDiscard.checked = !!filters.showDiscard;
    modal.open(ui.filterModal);
  }

  function closeFilter(){
    modal.close(ui.filterModal);
  }

  function applyFilterFromUI(){
    filters.assignee = ui.f_assignee.value || '';
    filters.dueTo = ui.f_dueTo.value || '';
    filters.priority = ui.f_priority.value || '';
    filters.status = ui.f_status.value || '';
    filters.showDone = !!ui.f_showDone.checked;
    filters.showDiscard = !!ui.f_showDiscard.checked;
    renderCards();
    setStatus('絞り込みを適用しました。', false);
  }

  function clearFilter(){
    Object.assign(filters, {
      assignee:'', dueTo:'', priority:'', status:'',
      showDone:false, showDiscard:false
    });
    ui.f_assignee.value = '';
    ui.f_dueTo.value = '';
    ui.f_priority.value = '';
    ui.f_status.value = '';
    ui.f_showDone.checked = false;
    ui.f_showDiscard.checked = false;
    renderCards();
    setStatus('絞り込みをクリアしました。', false);
  }

  // =========
  // Edit modal
  // =========
  function openEdit(mode, taskObj){
    setBodyScrollLock(true);
    modal.open(ui.editModal);

    ui.editTitle.textContent = (mode === 'edit') ? 'タスク修正' : 'タスク追加';
    ui.i_save.textContent = '登録';

    ui.i_task.value = taskObj?.task || '';
    ui.i_category.value = taskObj?.category || '';
    ui.i_genre.value = taskObj?.genre || '';
    ui.i_due.value = taskObj?.due ? time.toYMD(taskObj.due) : '';
    ui.i_priority.value = taskObj?.priority || '';
    ui.i_status.value = taskObj?.status || '';
    ui.i_note.value = taskObj?.note || '';
    renderAssigneeCheckboxes(String(taskObj?.assignee||'').split(',').map(x=>x.trim()).filter(Boolean));

    ui.editModal.dataset.mode = mode;
    ui.editModal.dataset.rowNumber = taskObj?.rowNumber ? String(taskObj.rowNumber) : '';
  }

  function closeEdit(){
    modal.close(ui.editModal);
    // busy/confirm は App 側で管理
    setBodyScrollLock(false);
  }

  function getEditData(){
    return {
      task: ui.i_task.value,
      category: ui.i_category.value,
      genre: ui.i_genre.value,
      assignee: getSelectedAssignees(),
      due: ui.i_due.value || null,
      priority: ui.i_priority.value,
      status: ui.i_status.value,
      note: ui.i_note.value
    };
  }

  function validateEditData(data){
    if(!(data.task || '').trim()) return 'タスク内容は必須です。';
    return null;
  }

  // =========
  // Confirm modal
  // =========
  function buildConfirmText(data, mode){
    const title = (mode === 'edit') ? '【修正】' : '【追加】';
    const asg = (data.assignee || []).join(', ');
    return [
      `${title}`,
      `タスク内容：${data.task || ''}`,
      `分類：${data.category || ''}`,
      `ジャンル：${data.genre || ''}`,
      `担当：${asg}`,
      `期限：${data.due || ''}`,
      `優先度：${data.priority || ''}`,
      `ステータス：${data.status || ''}`,
      `備考：${data.note || ''}`,
    ].join('\n');
  }

  // =========
  // Save flow
  // =========
  async function performSave(p){
    // p: { mode, rowNumber, data }
    setStatus((p.mode==='edit') ? '更新中...' : '追加中...', true);

    busy.show();

    try{
      const res = await callWithTimeout('api_upsertTask', {
        mode: p.mode,
        rowNumber: p.rowNumber,
        data: p.data
      }, 30000, '保存');

      if(!res.ok) throw new Error(res.message || '保存に失敗しました');

      busy.hide();
      App.modal?.info(p.mode === 'edit' ? '更新しました' : '追加しました');

      closeEdit();
      setBodyScrollLock(false);

      await loadTasks();
      setStatus('完了しました。', false);

    } catch(e){
      console.error(e);
      busy.hide();
      // editModal は残す（戻れる）
      setStatus('保存に失敗しました：' + (e.message||e), false);
      App.modal?.error('保存に失敗しました：' + (e.message||e));
    }
  }

  // =========
  // Events
  // =========
  ui.btnFilter.onclick = openFilter;
  ui.btnAdd.onclick = ()=> openEdit('create', null);

  ui.btnEdit.onclick = ()=>{
    if(!selectedRowNumber) return;
    const t = allTasks.find(x=>x.rowNumber === selectedRowNumber);
    if(!t) return App.modal?.warn('選択行が見つかりません。再読み込みしてください。');
    openEdit('edit', t);
  };

  ui.f_apply.onclick = ()=>{ applyFilterFromUI(); closeFilter(); };
  ui.f_clear.onclick = clearFilter;
  ui.f_close.onclick = closeFilter;

  ui.i_cancel.onclick = ()=>{
    closeEdit();
    setBodyScrollLock(false);
  };

  ui.i_save.onclick = ()=>{
    const mode = ui.editModal.dataset.mode || 'create';
    const rowNumber = Number(ui.editModal.dataset.rowNumber || NaN);
    const data = getEditData();

    const err = validateEditData(data);
    if(err) return App.modal?.warn(err);

    pendingSave = { mode, rowNumber, data };
    (async ()=>{
      const ok = await App.modal?.confirm(buildConfirmText(data, mode), {
        title: 'この内容で登録します。よろしいですか？',
        okText: 'はい',
        cancelText: 'いいえ'
      });
      if(!ok) return;
      await performSave(pendingSave);
      pendingSave = null;
    })();
  };

  // 画面サイズで担当欄を調整
  if (window.__TASK_RESIZE_HANDLER__) {
    window.removeEventListener('resize', window.__TASK_RESIZE_HANDLER__);
  }
  window.__TASK_RESIZE_HANDLER__ = ()=>{
    if(ui.editModal.style.display === 'block'){
      if (window.matchMedia('(max-width: 520px)').matches) ui.i_assigneeBox.style.gridTemplateColumns = '1fr';
      else ui.i_assigneeBox.style.gridTemplateColumns = '1fr 1fr';
    }
  };
  window.addEventListener('resize', window.__TASK_RESIZE_HANDLER__);

  // =========
  // Start
  // =========
  loadTasks();
  bindBasicFieldBehaviors();
};
</script>

