<section class="card">
  <h1>会計管理</h1>
  <div class="notice" id="ac_status">準備中...</div>
</section>

<section class="card">
  <div class="btn-row" style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
    <button id="ac_filterOpen" class="btn secondary">絞り込み</button>
    <!-- ★右寄せ用のスペーサ -->
    <div style="flex:1 1 auto;"></div>
    <button id="ac_add" class="btn">追加</button>
    <button id="ac_edit" class="btn">修正</button>
  </div>
</section>

<section class="card">
  <h2>会計情報</h2>

  <div class="grid" style="grid-template-columns:1fr; gap:12px; margin-top:10px;">
    <div>
      <h3 style="margin:0 0 8px;">精算依頼前</h3>
      <div id="ac_list_pre"></div>
      <div class="btn-row" style="margin-top:10px; gap:10px; flex-wrap:wrap; justify-content:flex-end;">
        <button id="ac_selAllPre" class="btn secondary">ALL</button>
        <button id="ac_toRequested" class="btn">精算依頼済みにする</button>
      </div>
    </div>

    <div>
      <h3 style="margin:0 0 8px;">精算依頼済み</h3>
      <div id="ac_list_req"></div>
      <div class="btn-row" style="margin-top:10px; gap:10px; flex-wrap:wrap; justify-content:flex-end;">
        <button id="ac_selAllReq" class="btn secondary">ALL</button>
        <button id="ac_toDone" class="btn">精算済みにする</button>
      </div>      
    </div>

    <div>
      <h3 style="margin:0 0 8px;">精算済み</h3>
      <div id="ac_list_done"></div>
    </div>
  </div>
</section>

<!-- 絞り込みモーダル -->
<div id="ac_filterModal" style="display:none; position:fixed; inset:0; z-index:10035; background:rgba(0,0,0,.55);">
  <div style="max-width:720px; margin:10vh auto; padding:14px; border-radius:16px; border:1px solid var(--line); background:rgba(18,26,39,.98);">
    <h2 style="margin:0 0 10px;">絞り込み</h2>

    <div class="grid" style="grid-template-columns:1fr 1fr; gap:12px;">
      <div class="field" style="grid-column:1 / -1;">
        <div class="label">キーワード（経費内容/説明）</div>
        <input id="ac_f_kw" placeholder="例：交通費 / 駐車場 / 打ち上げ" />
      </div>

      <div class="field">
        <div class="label">支払者</div>
        <select id="ac_f_payer">
          <option value="">（指定なし）</option>
          <option value="けいちゃん">けいちゃん</option>
          <option value="キム">キム</option>
          <option value="小澤">小澤</option>
        </select>
      </div>

      <div class="field">
        <div class="label">ステータス</div>
        <select id="ac_f_status">
          <option value="">（指定なし）</option>
          <option value="精算依頼前">精算依頼前</option>
          <option value="精算依頼済み">精算依頼済み</option>
          <option value="精算済み">精算済み</option>
        </select>
      </div>

      <div class="field">
        <div class="label">支払日 From</div>
        <input id="ac_f_from" type="date" />
      </div>

      <div class="field">
        <div class="label">支払日 To</div>
        <input id="ac_f_to" type="date" />
      </div>
    </div>

    <div class="btn-row" style="margin-top:14px; justify-content:flex-end; gap:10px; flex-wrap:wrap;">
      <button id="ac_clear" class="btn secondary">クリア</button>
      <button id="ac_filterClose" class="btn secondary">閉じる</button>
      <button id="ac_apply" class="btn btn-primary">適用</button>
    </div>
  </div>
</div>

<!-- 入力モーダル -->
<div id="ac_modal" style="
  display:none;
  position:fixed;
  inset:0;
  z-index:10035;
  background:rgba(0,0,0,.55);
  padding:12px;
  padding-bottom:calc(12px + env(safe-area-inset-bottom));
  box-sizing:border-box;
">
  <div style="
    width:min(720px, 100%);
    max-height:calc(100dvh - 24px - env(safe-area-inset-bottom));
    margin:0 auto;
    border-radius:16px;
    border:1px solid var(--line);
    background:rgba(18,26,39,.98);
    display:flex;
    flex-direction:column;
    overflow:hidden;
    box-sizing:border-box;
  ">
    <!-- header -->
    <div style="padding:14px; border-bottom:1px solid var(--line); flex:0 0 auto;">
      <h2 id="ac_m_title" style="margin:0;">経費入力</h2>
      <div class="notice" id="ac_m_status" style="margin-top:10px;">入力してください。</div>
    </div>

    <!-- body (縦スクロールOK / 横スクロール禁止) -->
    <div style="
      padding:14px;
      overflow:auto;
      -webkit-overflow-scrolling:touch;
      min-height:0;
      overscroll-behavior:contain;
    ">
      <div class="ac-grid">
        <div class="field ac-span2">
          <div class="label">経費内容（必須）</div>
          <input id="ac_m_titleInput" placeholder="例：駐車場代 / 交通費 / 飲食代" />
        </div>

        <div class="field ac-span2">
          <div class="label">説明</div>
          <input id="ac_m_descInput" placeholder="補足や内訳など" />
        </div>

        <div class="field">
          <div class="label">支払者</div>
          <select id="ac_m_payer">
            <option value="">（未選択）</option>
            <option value="けいちゃん">けいちゃん</option>
            <option value="キム">キム</option>
            <option value="小澤">小澤</option>
          </select>
        </div>

        <div class="field">
          <div class="label">支払日（yyyy/MM/dd）</div>
          <input id="ac_m_payDate" type="date" />
        </div>

        <div class="field">
          <div class="label">ステータス</div>
          <select id="ac_m_statusSel">
            <option value="精算依頼前">精算依頼前</option>
            <option value="精算依頼済み">精算依頼済み</option>
            <option value="精算済み">精算済み</option>
          </select>
        </div>

        <div class="field">
          <div class="label">領収書（ファイル添付）</div>
          <input id="ac_m_file" type="file" accept="image/*,application/pdf" />

          <div class="notice" style="margin-top:8px;">
            <div>現在の領収書：</div>
            <div id="ac_m_receiptLink" class="ac-break" style="margin-top:4px;"></div>

            <!-- ★追加 -->
            <div style="margin-top:6px; color:var(--muted); font-size:12px;">
              保存予定ファイル名：
              <span id="ac_m_filename">（未確定）</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- footer -->
    <div class="btn-row" style="
      padding:14px;
      border-top:1px solid var(--line);
      justify-content:flex-end;
      gap:10px;
      flex:0 0 auto;
    ">
      <button id="ac_m_close" class="btn secondary">閉じる</button>
      <button id="ac_m_save" class="btn btn-primary">登録</button>
    </div>
  </div>
</div>

<script>
window.accountingInit = function accountingInit(){
  const $ = (s)=>document.querySelector(s);
  const App = window.App || {};

  // ---- required DOM
  const statusEl = $('#ac_status');
  if(!statusEl) return;
  if(statusEl.dataset.inited === '1') return;
  statusEl.dataset.inited = '1';

  const hostPre  = $('#ac_list_pre');
  const hostReq  = $('#ac_list_req');
  const hostDone = $('#ac_list_done');

  const btnAdd     = $('#ac_add');
  const btnEdit    = $('#ac_edit');
  const btnToReq   = $('#ac_toRequested');
  const btnToDone  = $('#ac_toDone');
  const btnAllPre  = $('#ac_selAllPre');
  const btnAllReq  = $('#ac_selAllReq');

  const filterOpen  = $('#ac_filterOpen');
  const filterModal = $('#ac_filterModal');
  const filterClose = $('#ac_filterClose');
  const btnApply    = $('#ac_apply');
  const btnClear    = $('#ac_clear');

  const fKw     = $('#ac_f_kw');
  const fPayer  = $('#ac_f_payer');
  const fFrom   = $('#ac_f_from');
  const fTo     = $('#ac_f_to');
  const fStatus = $('#ac_f_status');

  const modal = $('#ac_modal');

  const mTitle       = $('#ac_m_title');
  const mStatus      = $('#ac_m_status');
  const mTitleInput  = $('#ac_m_titleInput');
  const mDescInput   = $('#ac_m_descInput');
  const mPayer       = $('#ac_m_payer');
  const mPayDate     = $('#ac_m_payDate');
  const mStatusSel   = $('#ac_m_statusSel');
  const mFile        = $('#ac_m_file');
  const mReceiptLink = $('#ac_m_receiptLink');
  const mClose       = $('#ac_m_close');
  const mSave        = $('#ac_m_save');

  const fileNameEl = document.getElementById('ac_m_filename');

  // ---- server bridge
  if (typeof callServer !== 'function'){
    statusEl.textContent = 'エラー：callServer が見つかりません';
    return;
  }

  // ---- utils
  const esc = App.escapeHtml
    ? (s)=>App.escapeHtml(s)
    : (s)=>String(s??'')
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'","&#039;");

  const setStatus = (t, busyFlg) => App.setStatus(statusEl, t, busyFlg);
  const busy = App.makeBusy('経費を登録中しています。\nしばらくお待ちください。', { title: '登録中です…' });
const openModal = ()=> App.openModal(modal);
  const closeModal = ()=> App.closeModal(modal);
  const openFilter = ()=> App.openModal(filterModal);
  const closeFilter = ()=> App.closeModal(filterModal);

  function isoToYMD(iso){
    if(!iso) return '';
    const d = new Date(iso);
    if (isNaN(d.getTime())) return '';
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const dd = String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${dd}`;
  }

  function fmtYMD(v){
    if(!v) return '';
    const d = new Date(v);
    if (isNaN(d.getTime())) return String(v);
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const dd = String(d.getDate()).padStart(2,'0');
    return `${y}/${m}/${dd}`;
  }

  // ---- styles (1回だけ)
  if(!document.getElementById('ac_style_v3')){
    const st = document.createElement('style');
    st.id = 'ac_style_v3';
    st.textContent = `
      .ac-list{ display:grid; gap:10px; }
      .ac-row{
        border:1px solid var(--line);
        background: rgba(255,255,255,.03);
        transition: border-color .12s ease, background .12s ease;
      }
      .ac-row:hover{
        border-color: rgba(140,200,255,.35);
        background: rgba(140,200,255,.06);
      }
      .ac-row.is-selected{
        border-color: rgba(140,200,255,.85);
        background: rgba(140,200,255,.12);
        box-shadow: 0 0 0 1px rgba(140,200,255,.22) inset;
      }
      .ac-check{
        width:18px; height:18px;
        margin-top:3px;
        accent-color: rgba(140,200,255,1);
      }
      .pill{
        display:inline-flex;
        align-items:center;
        padding:2px 8px;
        border-radius:999px;
        border:1px solid var(--line);
        background: rgba(255,255,255,.06);
        font-size:12px;
        color: var(--muted);
      }
      .link{
        color: rgba(140,200,255,1);
        text-decoration: none;
        border-bottom: 1px solid rgba(140,200,255,.35);
      }
      .link:hover{ border-bottom-color: rgba(140,200,255,.9); }
    `;
    document.head.appendChild(st);
  }

  // ---- state
  let allExpenses = [];
  const selected = new Set(); // key: rowNumber（更新用）
  let modalMode = 'create';
  let editingRowNumber = null;
  let currentReceiptUrl = '';

  // ---- 正規化：サーバー戻りのキーゆれを吸収
  function normalizeExpense(raw){
    const rowNumber =
      Number(raw?.rowNumber) ||
      Number(raw?.row) ||
      Number(raw?.rowIndex) ||
      null;

    const seq =
      (raw?.seq != null ? Number(raw.seq) : null) ||
      (raw?.no != null ? Number(raw.no) : null) ||
      null;

    const title = String(raw?.title ?? raw?.expense ?? raw?.content ?? raw?.name ?? '').trim();
    const desc  = String(raw?.desc  ?? raw?.description ?? raw?.note ?? '');
    const payer = String(raw?.payer ?? raw?.paidBy ?? raw?.payee ?? '');

    const payDate    = raw?.payDate ?? raw?.paidAt ?? raw?.date ?? null;
    const receiptUrl = String(raw?.receiptUrl ?? raw?.receipt ?? raw?.url ?? '').trim();

    let status = String(raw?.status ?? '').trim();
    if(status === '精算前') status = '精算依頼前';
    if(status === '依頼前') status = '精算依頼前';
    if(status === '依頼済') status = '精算依頼済み';
    if(status === '精算完了') status = '精算済み';

    const requestDate = raw?.requestDate ?? raw?.requestedAt ?? null;
    const settleDate  = raw?.settleDate  ?? raw?.doneAt ?? null;

    return { rowNumber, seq, title, desc, payer, payDate, receiptUrl, status, requestDate, settleDate, _raw: raw };
  }

  function getFilter(){
    return {
      kw: (fKw?.value || ''),
      payer: (fPayer?.value || ''),
      from: (fFrom?.value || ''),
      to: (fTo?.value || ''),
      status: (fStatus?.value || ''),
    };
  }

  function matchesFilter(x, f){
    const kw = (f.kw||'').trim().toLowerCase();
    if(kw){
      const t = (x.title||'').toLowerCase();
      const d = (x.desc||'').toLowerCase();
      if(!t.includes(kw) && !d.includes(kw)) return false;
    }

    if((f.payer||'').trim()){
      if(String(x.payer||'').trim() !== f.payer.trim()) return false;
    }

    if((f.status||'').trim()){
      if(String(x.status||'').trim() !== f.status.trim()) return false;
    }

    const from = f.from ? new Date(f.from + 'T00:00:00') : null;
    const to   = f.to   ? new Date(f.to   + 'T23:59:59') : null;

    if(from || to){
      const pd = x.payDate ? new Date(x.payDate) : null;
      if(!pd || isNaN(pd.getTime())) return false;
      if(from && pd.getTime() < from.getTime()) return false;
      if(to   && pd.getTime() > to.getTime()) return false;
    }
    return true;
  }

  function emptyBox(msg){
    return `<div class="notice" style="padding:10px; border-radius:14px;">${esc(msg)}</div>`;
  }

  function buildRowCard(x){
    const rn = Number(x.rowNumber);
    const hasRn = Number.isFinite(rn) && rn > 0;
    const isSel = hasRn ? selected.has(rn) : false;

    const receipt = (x.receiptUrl||'').trim()
      ? `<a href="${esc(x.receiptUrl)}" target="_blank" rel="noopener" class="link">領収書</a>`
      : `<span style="color:var(--muted);">（領収書なし）</span>`;

    const badge = `<span class="pill">${esc(x.status||'（未設定）')}</span>`;
    const payDate  = fmtYMD(x.payDate);
    const reqDate  = fmtYMD(x.requestDate);
    const doneDate = fmtYMD(x.settleDate);

    const lineLabel = (x.seq != null && !Number.isNaN(Number(x.seq)))
      ? `SEQ：${Number(x.seq)}`
      : (hasRn ? `SEQ：${rn}` : `SEQ：?`);

    return `
      <div class="notice ac-row ${isSel ? 'is-selected' : ''}"
        ${hasRn ? `data-row="${rn}"` : ''}
        style="display:flex; gap:10px; align-items:flex-start; padding:10px; border-radius:14px; cursor:${hasRn?'pointer':'default'};">
        ${hasRn ? `<input class="ac-check" type="checkbox" data-sel="${rn}" ${isSel ? 'checked' : ''} onclick="event.stopPropagation()">`
                : `<span style="width:18px; height:18px; display:inline-block;"></span>`}
        <div style="min-width:0; flex:1 1 auto;">
          <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
            <b style="white-space:nowrap;">${esc(x.title||'（タイトルなし）')}</b>
            ${badge}
          </div>
          <div style="margin-top:6px; color:var(--muted); line-height:1.5; word-break:break-word;">
            ${esc(x.desc||'')}
          </div>
          <div style="margin-top:8px; display:flex; gap:10px; flex-wrap:wrap; color:var(--muted);">
            <span>${lineLabel}</span>
            <span>支払者：${esc(x.payer||'')}</span>
            <span>支払日：${esc(payDate||'')}</span>
            ${reqDate ? `<span>依頼日：${esc(reqDate)}</span>` : ``}
            ${doneDate ? `<span>精算日：${esc(doneDate)}</span>` : ``}
            <span>${receipt}</span>
          </div>
        </div>
      </div>
    `;
  }

  // ===== 描画 =====
  function render(){
    const f = getFilter();
    const filtered = (allExpenses||[]).filter(x=>matchesFilter(x, f));

    const pre  = filtered.filter(x=>String(x.status||'').trim()==='精算依頼前');
    const req  = filtered.filter(x=>String(x.status||'').trim()==='精算依頼済み');
    const done = filtered.filter(x=>String(x.status||'').trim()==='精算済み');

    hostPre.innerHTML  = pre.length  ? `<div class="ac-list">${pre.map(buildRowCard).join('')}</div>` : emptyBox('該当なし');
    hostReq.innerHTML  = req.length  ? `<div class="ac-list">${req.map(buildRowCard).join('')}</div>` : emptyBox('該当なし');
    hostDone.innerHTML = done.length ? `<div class="ac-list">${done.map(buildRowCard).join('')}</div>` : emptyBox('該当なし');

    setStatus(`表示：${filtered.length}件（依頼前${pre.length} / 依頼済${req.length} / 済${done.length}）`, false);
  }

  // ✅ 互換：saveModal等が renderLists を呼んでも落ちないように残す
  function renderLists(_expenses, _filter){
    // 旧コード互換。内部state基準で描画する設計に統一
    render();
  }

  // ---- イベント委譲：renderのたびに付け直さない
  function onListClick(e){
    const row = e.target.closest('.ac-row[data-row]');
    if(!row) return;
    const rn = Number(row.dataset.row);
    if(!Number.isFinite(rn)) return;

    // checkbox 自体のクリックは onchange で処理
    if(e.target && e.target.matches('input[type="checkbox"][data-sel]')) return;

    if(selected.has(rn)) selected.delete(rn);
    else selected.add(rn);
    render();
  }
  function onCheckboxChange(e){
    const cb = e.target;
    if(!cb || !cb.matches('input[type="checkbox"][data-sel]')) return;
    const rn = Number(cb.dataset.sel);
    if(!Number.isFinite(rn)) return;
    if(cb.checked) selected.add(rn);
    else selected.delete(rn);
    render();
  }

  [hostPre, hostReq, hostDone].forEach(h=>{
    h.addEventListener('click', onListClick);
    h.addEventListener('change', onCheckboxChange);
  });

  // ---- data load
  async function loadAll(){
    setStatus('会計シートから取得中...', true);
    const res = await callServer('api_listExpenses', {});
    if(!res || !res.ok) throw new Error(res?.message || '取得に失敗しました');

    const rawList = Array.isArray(res.expenses) ? res.expenses : [];
    const list = rawList.map(normalizeExpense);

    const missingRow = list.some(x => !Number.isFinite(Number(x.rowNumber)));
    if(missingRow){
      console.warn('rowNumber が不足しています。api_listExpenses が rowNumber を返しているか確認してください。', res);
    }
    return list;
  }

  // ---- modal helpers
  function setModalStatus(t, busyFlg){
    mStatus.textContent = t;
    mStatus.style.borderColor = busyFlg ? 'rgba(78,161,255,.55)' : 'var(--line)';
  }

  function setReceiptLink(url){
    currentReceiptUrl = String(url||'').trim();
    mReceiptLink.innerHTML = currentReceiptUrl
      ? `<a class="link" href="${esc(currentReceiptUrl)}" target="_blank" rel="noopener">${esc(currentReceiptUrl)}</a>`
      : `<span style="color:var(--muted);">（なし）</span>`;
  }

  function resetModal(){
    mTitleInput.value = '';
    mDescInput.value = '';
    mPayer.value = '';
    mPayDate.value = '';
    mStatusSel.value = '精算依頼前';
    mFile.value = '';
    currentReceiptUrl = '';
    mReceiptLink.innerHTML = `<span style="color:var(--muted);">（なし）</span>`;
    if(fileNameEl) fileNameEl.textContent = '（未確定）';
  }

  function openCreate(){
    modalMode = 'create';
    editingRowNumber = null;
    mTitle.textContent = '経費追加';
    resetModal();
    setModalStatus('入力してください。', false);
    openModal();
  }

  function pickSelectedOne(){
    const arr = Array.from(selected.values());
    if(arr.length !== 1) throw new Error('修正は1件のみ選択してください。');
    const rn = arr[0];
    const x = allExpenses.find(e => Number(e.rowNumber) === Number(rn));
    if(!x) throw new Error('選択行のデータが見つかりません。再取得してください。');
    return x;
  }

  function openEdit(expense){
    modalMode = 'edit';
    editingRowNumber = expense.rowNumber;
    mTitle.textContent = `経費修正（SEQ：${expense.seq ?? editingRowNumber}）`;

    resetModal();
    mTitleInput.value = expense.title || '';
    mDescInput.value  = expense.desc || '';
    mPayer.value      = expense.payer || '';
    mPayDate.value    = isoToYMD(expense.payDate);
    mStatusSel.value  = expense.status || '精算依頼前';
    setReceiptLink(expense.receiptUrl || '');

    setModalStatus('修正内容を入力してください。', false);
    openModal();
  }

  function fileToBase64(file){
    return new Promise((resolve, reject)=>{
      const reader = new FileReader();
      reader.onload = ()=>{
        const dataUrl = String(reader.result||'');
        const m = dataUrl.match(/^data:(.+);base64,(.+)$/);
        if(!m) return reject(new Error('base64 変換に失敗しました'));
        resolve({ mime:m[1], base64:m[2] });
      };
      reader.onerror = ()=>reject(new Error('ファイル読み込みに失敗しました'));
      reader.readAsDataURL(file);
    });
  }

  function buildReceiptFileName(){
    const date  = mPayDate.value; // yyyy-MM-dd
    const payer = (mPayer.value || '').trim();
    const title = (mTitleInput.value || '').trim();
    if(!date || !payer || !title) return '';
    const ymd = date.replaceAll('-', '');
    return `${ymd}_${payer}_${title}`;
  }
  function updatePlannedFileName(){
    if(!fileNameEl) return;
    const name = buildReceiptFileName();
    fileNameEl.textContent = name || '（支払日・支払者・経費内容を入力してください）';
  }

  async function buildSavePayload(){
    const title = (mTitleInput.value||'').trim();
    if(!title) return App.modal?.warn('経費内容は必須です。');

    const file = mFile.files && mFile.files[0] ? mFile.files[0] : null;

    // 編集モード + 既存URLあり + 新規ファイル選択 → 確認
    let oldReceiptUrl = '';
    if (modalMode === 'edit' && file && (currentReceiptUrl||'').trim()) {
      const ok = await App.modal?.confirm('すでに保存済みの領収書が削除されます。よろしいですか？');
      if (!ok) return null;
      oldReceiptUrl = (currentReceiptUrl||'').trim();
    }

    const payload = {
      mode: modalMode,
      rowNumber: editingRowNumber,
      data: {
        title,
        desc: (mDescInput.value||'').trim(),
        payer: (mPayer.value||'').trim(),
        payDate: (mPayDate.value||'') ? String(mPayDate.value) : null, // YYYY-MM-DD
        status: (mStatusSel.value||'精算依頼前').trim(),
        receiptUrl: currentReceiptUrl || ''
      }
    };

    return { payload, file, oldReceiptUrl };
  }

  function buildConfirmText(payload){
    const d = payload.data || {};
    const title = (payload.mode === 'edit') ? '【修正】' : '【追加】';
    const payDate = d.payDate || '';
    return [
      `${title}`,
      `経費内容：${d.title || ''}`,
      `説明：${d.desc || ''}`,
      `支払者：${d.payer || ''}`,
      `支払日：${payDate}`,
      `ステータス：${d.status || ''}`,
      `領収書：${d.receiptUrl ? 'あり（既存）' : 'なし'}`,
    ].join('\n');
  }

    async function saveModalCore(p){
      const payload = p?.payload;
      const file = p?.file;
      const oldReceiptUrl = p?.oldReceiptUrl || '';
      if(!payload) throw new Error('payloadがありません');

      setModalStatus('登録中...', true);
      mSave.disabled = true;

      // 先にアップロード（必要なら）
      if(file){
        const { mime, base64 } = await fileToBase64(file);
        const payDate = (payload.data.payDate||''); // YYYY-MM-DD
        const payer   = (payload.data.payer||'').trim();
        const title2  = (payload.data.title||'').trim();

        const up = await callServer('api_uploadReceipt', {
          name: file.name || 'receipt',
          mime,
          base64,
          payDate,
          payer,
          title: title2,
          oldReceiptUrl
        });
        if(!up || !up.ok) throw new Error(up?.message || '領収書アップロードに失敗しました');

        setReceiptLink(up.url);
        payload.data.receiptUrl = up.url || '';
      }

      const res = await callServer('api_upsertExpense', payload);
      if(!res || !res.ok) throw new Error(res?.message || '保存に失敗しました');

      // 再取得して描画
      allExpenses = await loadAll();
      render(); // ← renderListsではなく、今の設計に合わせて render に統一

      return res;
    }

    async function performSave(p){
      // task.htmlと同様：confirm→busy→保存→busy閉→完了
      busy.show();
      try{
        const res = await saveModalCore(p);

        busy.hide();
        App.modal?.info(res.message || '保存しました');

        closeModal();          // 入力モーダルを閉じる

        // 入力モーダルが閉じたのでスクロール解除
        if (App.unlockBodyScroll) App.unlockBodyScroll();
        else document.body.style.overflow = '';

        setStatus('完了しました。', false);

      }catch(e){
        console.error(e);
        busy.hide();

        // 入力モーダルは残す（戻って修正できる）
        setModalStatus('保存に失敗しました：' + (e.message||e), false);
        App.modal?.error('保存に失敗しました：' + (e.message||e));

      }finally{
        mSave.disabled = false;
        // 失敗時はメッセージ残したいので、成功時だけ戻したい場合はここは消してOK
        // setModalStatus('入力してください。', false);
      }
    }


  function toggleAllByStatus(status){
    const f = getFilter();
    const targets = (allExpenses||[])
      .filter(x=>matchesFilter(x, f))
      .filter(x=>String(x.status||'').trim()===status)
      .filter(x=>Number.isFinite(Number(x.rowNumber)));

    if(!targets.length) return;

    const allSelected = targets.every(x => selected.has(Number(x.rowNumber)));
    if(allSelected) targets.forEach(x=>selected.delete(Number(x.rowNumber)));
    else targets.forEach(x=>selected.add(Number(x.rowNumber)));

    render();
  }

  async function bulkUpdate(fromStatus, toStatus){
    const selectedRows = Array.from(selected.values());
    if(!selectedRows.length) return App.modal?.warn('対象を選択してください。');

    const invalid = selectedRows
      .map(rn => allExpenses.find(x=>Number(x.rowNumber)===Number(rn)))
      .filter(x => !x || String(x.status||'').trim() !== fromStatus);

    if(invalid.length){
      return App.modal?.warn(`「${fromStatus}」以外が含まれています。対象を見直してください。`);
    }

    const ok = await App.modal?.confirm(`${selectedRows.length}件を「${toStatus}」に変更します。よろしいですか？`,{
      okText: 'はい',
      cancelText: 'いいえ'
    });
    if(!ok) return;

    busy.show();
    try{
      const res = await callServer('api_bulkUpdateExpenseStatus', {
        rowNumbers: selectedRows,
        newStatus: toStatus
      });
      if(!res || !res.ok) throw new Error(res?.message || '更新に失敗しました');

      allExpenses = await loadAll();
      selected.clear();
      render();

      App.modal?.info(res.message || '更新しました');
    }catch(e){
      console.error(e);
      App.modal?.error('更新に失敗しました：' + (e.message||e));
    }finally{
      busy.hide();
    }
  }

  // ===== 入力補助（blur）=====
  function showFieldWarn(inputEl, msg){
    const id = inputEl.id + '_warn';
    let w = document.getElementById(id);
    if(!w){
      w = document.createElement('div');
      w.id = id;
      w.style.marginTop = '6px';
      w.style.fontSize = '12px';
      w.style.color = '#ffb4b4';
      inputEl.parentElement.appendChild(w);
    }
    w.textContent = msg || '';
    inputEl.style.borderColor = msg ? 'rgba(255,120,120,.75)' : '';
  }
  function clearFieldWarn(inputEl){ showFieldWarn(inputEl,''); }

  function bindBasicFieldBehaviors(){
    const keihi = ac_m_titleInput;

    if(!keihi) return;

    keihi.onblur = () => {
      const v = (keihi.value || '').trim();
      if(!v) showFieldWarn(keihi,'経費内容は必須です。');
      else clearFieldWarn(keihi);
    };
  }

  // ---- events (二重代入しない / addEventListenerで統一)
  btnAdd.addEventListener('click', openCreate);

  btnEdit.addEventListener('click', ()=>{
    try{
      const x = pickSelectedOne();
      openEdit(x);
    }catch(e){
      App.modal?.warn(e.message||String(e));
    }
  });

  btnAllPre.addEventListener('click', ()=> toggleAllByStatus('精算依頼前'));
  btnAllReq.addEventListener('click', ()=> toggleAllByStatus('精算依頼済み'));

  btnToReq.addEventListener('click', ()=> bulkUpdate('精算依頼前', '精算依頼済み'));
  btnToDone.addEventListener('click', ()=> bulkUpdate('精算依頼済み', '精算済み'));

  mClose.addEventListener('click', closeModal);
  mSave.addEventListener('click', async ()=>{
    const built = await buildSavePayload();
    if(!built) return;
    const ok = await App.modal?.confirm(buildConfirmText(built.payload), {
      title: 'この内容で登録します。よろしいですか？',
      okText: 'はい',
      cancelText: 'いいえ'
    });
    if(!ok) return;
    await performSave(built);
  });

  filterOpen.addEventListener('click', openFilter);
  filterClose.addEventListener('click', closeFilter);

  btnApply.addEventListener('click', ()=>{
    render();
    closeFilter();
  });

  btnClear.addEventListener('click', ()=>{
    fKw.value=''; fPayer.value=''; fFrom.value=''; fTo.value=''; fStatus.value='';
    render();
  });

  mPayDate.addEventListener('input', updatePlannedFileName);
  mPayer.addEventListener('change', updatePlannedFileName);
  mTitleInput.addEventListener('input', updatePlannedFileName);
  mFile.addEventListener('change', updatePlannedFileName);

  // ---- init
  (async ()=>{
    try{
      setStatus('読み込み中...', true);
      allExpenses = await loadAll();

      const statuses = Array.from(new Set(allExpenses.map(x=>String(x.status||'').trim()).filter(Boolean)));
      console.log('accounting statuses:', statuses);

      selected.clear();
      render();
    }catch(e){
      console.error(e);
      setStatus('読み込みに失敗しました：' + (e.message||e), false);
      App.modal?.error('読み込みに失敗しました：' + (e.message||e));
    }
  })();
  bindBasicFieldBehaviors();
};
</script>




