<section class="card">
  <h1>会計管理</h1>
  <div class="notice" id="ac_status">準備中...</div>
</section>

<section class="card">
  <div class="btn-row" style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
    <button id="ac_filterOpen" class="btn secondary">絞り込み</button>
    <!-- ★右寄せ用のスペーサ -->
    <div style="flex:1 1 auto;"></div>
    <button id="ac_add" class="btn">追加</button>
    <button id="ac_edit" class="btn">修正</button>
  </div>
</section>

<section class="card">
  <h2>会計情報</h2>

  <div class="grid" style="grid-template-columns:1fr; gap:12px; margin-top:10px;">
    <div>
      <h3 style="margin:0 0 8px;">精算依頼前</h3>
      <div id="ac_list_pre"></div>
      <div class="btn-row" style="margin-top:10px; gap:10px; flex-wrap:wrap; justify-content:flex-end;">
        <button id="ac_selAllPre" class="btn secondary">ALL</button>
        <button id="ac_toRequested" class="btn">精算依頼済みにする</button>
      </div>
    </div>

    <div>
      <h3 style="margin:0 0 8px;">精算依頼済み</h3>
      <div id="ac_list_req"></div>
      <div class="btn-row" style="margin-top:10px; gap:10px; flex-wrap:wrap; justify-content:flex-end;">
        <button id="ac_selAllReq" class="btn secondary">ALL</button>
        <button id="ac_toDone" class="btn">精算済みにする</button>
      </div>      
    </div>

    <div>
      <h3 style="margin:0 0 8px;">精算済み</h3>
      <div id="ac_list_done"></div>
    </div>
  </div>
</section>

<!-- 絞り込みモーダル -->
<div id="ac_filterModal" style="display:none; position:fixed; inset:0; z-index:10035; background:rgba(0,0,0,.55);">
  <div style="max-width:720px; margin:10vh auto; padding:14px; border-radius:16px; border:1px solid var(--line); background:rgba(18,26,39,.98);">
    <h2 style="margin:0 0 10px;">絞り込み</h2>

    <div class="grid" style="grid-template-columns:1fr 1fr; gap:12px;">
      <div class="field" style="grid-column:1 / -1;">
        <div class="label">キーワード（経費内容/説明）</div>
        <input id="ac_f_kw" placeholder="例：交通費 / 駐車場 / 打ち上げ" />
      </div>

      <div class="field">
        <div class="label">支払者</div>
        <select id="ac_f_payer">
          <option value="">（指定なし）</option>
          <option value="けいちゃん">けいちゃん</option>
          <option value="キム">キム</option>
          <option value="小澤">小澤</option>
        </select>
      </div>

      <div class="field">
        <div class="label">ステータス</div>
        <select id="ac_f_status">
          <option value="">（指定なし）</option>
          <option value="精算依頼前">精算依頼前</option>
          <option value="精算依頼済み">精算依頼済み</option>
          <option value="精算済み">精算済み</option>
        </select>
      </div>

      <div class="field">
        <div class="label">支払日 From</div>
        <input id="ac_f_from" type="date" />
      </div>

      <div class="field">
        <div class="label">支払日 To</div>
        <input id="ac_f_to" type="date" />
      </div>
    </div>

    <div class="btn-row" style="margin-top:14px; justify-content:flex-end; gap:10px; flex-wrap:wrap;">
      <button id="ac_clear" class="btn secondary">クリア</button>
      <button id="ac_filterClose" class="btn secondary">閉じる</button>
      <button id="ac_apply" class="btn btn-primary">適用</button>
    </div>
  </div>
</div>

<!-- 入力モーダル -->
<div id="ac_modal" style="
  display:none;
  position:fixed;
  inset:0;
  z-index:10035;
  background:rgba(0,0,0,.55);
  padding:12px;
  padding-bottom:calc(12px + env(safe-area-inset-bottom));
  box-sizing:border-box;
">
  <div style="
    width:min(720px, 100%);
    max-height:calc(100dvh - 24px - env(safe-area-inset-bottom));
    margin:0 auto;
    border-radius:16px;
    border:1px solid var(--line);
    background:rgba(18,26,39,.98);
    display:flex;
    flex-direction:column;
    overflow:hidden;
    box-sizing:border-box;
  ">
    <!-- header -->
    <div style="padding:14px; border-bottom:1px solid var(--line); flex:0 0 auto;">
      <h2 id="ac_m_title" style="margin:0;">経費入力</h2>
      <div class="notice" id="ac_m_status" style="margin-top:10px;">入力してください。</div>
    </div>

    <!-- body -->
    <div style="
      padding:14px;
      overflow:auto;
      -webkit-overflow-scrolling:touch;
      min-height:0;
      overscroll-behavior:contain;
    ">
      <div class="ac-grid">
        <div class="field ac-span2">
          <div class="label">経費内容（必須）</div>
          <input id="ac_m_titleInput" placeholder="例：駐車場代 / 交通費 / 飲食代" />
        </div>

        <div class="field ac-span2">
          <div class="label">説明</div>
          <input id="ac_m_descInput" placeholder="補足や内訳など" />
        </div>

        <div class="field">
          <div class="label">支払者</div>
          <select id="ac_m_payer">
            <option value="">（未選択）</option>
            <option value="けいちゃん">けいちゃん</option>
            <option value="キム">キム</option>
            <option value="小澤">小澤</option>
          </select>
        </div>

        <div class="field">
          <div class="label">支払日（yyyy/MM/dd）</div>
          <input id="ac_m_payDate" type="date" />
        </div>

        <div class="field">
          <div class="label">ステータス</div>
          <select id="ac_m_statusSel">
            <option value="精算依頼前">精算依頼前</option>
            <option value="精算依頼済み">精算依頼済み</option>
            <option value="精算済み">精算済み</option>
            <option value="破棄">破棄</option>
          </select>
        </div>

        <div class="field">
          <div class="label">領収書（ファイル添付）</div>
          <input id="ac_m_file" type="file" accept="image/*,application/pdf" />

          <div class="notice" style="margin-top:8px;">
            <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;">
              <div>現在の領収書：</div>
              <!-- ★修正モードで既存領収書がある場合のみ表示 -->
              <button id="ac_m_deleteReceipt" type="button" class="btn secondary" style="display:none;">
                保存済み領収書を削除
              </button>
            </div>

            <div id="ac_m_receiptLink" class="ac-break" style="margin-top:4px;"></div>

            <div style="margin-top:6px; color:var(--muted); font-size:12px;">
              保存ファイル名：
              <span id="ac_m_filename"></span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- footer -->
    <div class="btn-row" style="
      padding:14px;
      border-top:1px solid var(--line);
      justify-content:flex-end;
      gap:10px;
      flex:0 0 auto;
    ">
      <button id="ac_m_close" class="btn secondary">閉じる</button>
      <button id="ac_m_save" class="btn btn-primary">登録</button>
    </div>
  </div>
</div>

<script>
window.accountingInit = function accountingInit(){
  const $ = (s)=>document.querySelector(s);
  const App = window.App || {};

  // ---- required DOM
  const statusEl = $('#ac_status');
  if(!statusEl) return;
  if(statusEl.dataset.inited === '1') return;
  statusEl.dataset.inited = '1';

  const hostPre  = $('#ac_list_pre');
  const hostReq  = $('#ac_list_req');
  const hostDone = $('#ac_list_done');

  const btnAdd     = $('#ac_add');
  const btnEdit    = $('#ac_edit');
  const btnToReq   = $('#ac_toRequested');
  const btnToDone  = $('#ac_toDone');
  const btnAllPre  = $('#ac_selAllPre');
  const btnAllReq  = $('#ac_selAllReq');

  const filterOpen  = $('#ac_filterOpen');
  const filterModal = $('#ac_filterModal');
  const filterClose = $('#ac_filterClose');
  const btnApply    = $('#ac_apply');
  const btnClear    = $('#ac_clear');

  const fKw     = $('#ac_f_kw');
  const fPayer  = $('#ac_f_payer');
  const fFrom   = $('#ac_f_from');
  const fTo     = $('#ac_f_to');
  const fStatus = $('#ac_f_status');

  const modal = $('#ac_modal');

  const mTitle       = $('#ac_m_title');
  const mStatus      = $('#ac_m_status');
  const mTitleInput  = $('#ac_m_titleInput');
  const mDescInput   = $('#ac_m_descInput');
  const mPayer       = $('#ac_m_payer');
  const mPayDate     = $('#ac_m_payDate');
  const mStatusSel   = $('#ac_m_statusSel');
  const mFile        = $('#ac_m_file');
  const mReceiptLink = $('#ac_m_receiptLink');
  const mClose       = $('#ac_m_close');
  const mSave        = $('#ac_m_save');

  const fileNameEl = document.getElementById('ac_m_filename');
  const btnDeleteReceipt = document.getElementById('ac_m_deleteReceipt');

  // ---- server bridge
  if (typeof callServer !== 'function'){
    statusEl.textContent = 'エラー：callServer が見つかりません';
    return;
  }

  // ---- utils
  const esc = App.escapeHtml
    ? (s)=>App.escapeHtml(s)
    : (s)=>String(s??'')
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'","&#039;");

  const setStatus = (t, busyFlg) => App.setStatus(statusEl, t, busyFlg);
  const busy = App.makeBusy('経費を登録しています。\nしばらくお待ちください。', { title: '登録中です…' });
  const openModal = ()=> App.openModal(modal);
  const closeModal = ()=> {
    App.closeModal(modal);
    clearFieldWarn(mTitleInput);
  }
  const openFilter = ()=> App.openModal(filterModal);
  const closeFilter = ()=> App.closeModal(filterModal);

  function isoToYMD(iso){
    if(!iso) return '';
    const d = new Date(iso);
    if (isNaN(d.getTime())) return '';
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const dd = String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${dd}`;
  }

  function fmtYMD(v){
    if(!v) return '';
    const d = new Date(v);
    if (isNaN(d.getTime())) return String(v);
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const dd = String(d.getDate()).padStart(2,'0');
    return `${y}/${m}/${dd}`;
  }

  // ---- styles (1回だけ)
  if(!document.getElementById('ac_style_v4')){
    const st = document.createElement('style');
    st.id = 'ac_style_v4';
    st.textContent = `
      .ac-list{ display:grid; gap:10px; }
      .ac-row{
        border:1px solid var(--line);
        background: rgba(255,255,255,.03);
        transition: border-color .12s ease, background .12s ease;
      }
      .ac-row:hover{
        border-color: rgba(140,200,255,.35);
        background: rgba(140,200,255,.06);
      }
      .ac-row.is-selected{
        border-color: rgba(140,200,255,.85);
        background: rgba(140,200,255,.12);
        box-shadow: 0 0 0 1px rgba(140,200,255,.22) inset;
      }
      .ac-check{
        width:18px; height:18px;
        margin-top:3px;
        accent-color: rgba(140,200,255,1);
      }
      .pill{
        display:inline-flex;
        align-items:center;
        padding:2px 8px;
        border-radius:999px;
        border:1px solid var(--line);
        background: rgba(255,255,255,.06);
        font-size:12px;
        color: var(--muted);
      }
      .link{
        color: rgba(140,200,255,1);
        text-decoration: none;
        border-bottom: 1px solid rgba(140,200,255,.35);
      }
      .link:hover{ border-bottom-color: rgba(140,200,255,.9); }
    `;
    document.head.appendChild(st);
  }

  // ---- state
  let allExpenses = [];
  const selected = new Set(); // key: rowNumber
  let modalMode = 'create';
  let editingRowNumber = null;

  let currentReceiptUrl = '';        // 入力モーダルが表示している「現在のURL」
  let originalReceiptUrl = '';       // 編集開始時点のURL（削除用）
  let receiptDeleteRequested = false; // 「保存済み領収書を削除」ボタンで true になる

  // ---- 正規化
  function normalizeExpense(raw){
    const rowNumber =
      Number(raw?.rowNumber) ||
      Number(raw?.row) ||
      Number(raw?.rowIndex) ||
      null;

    const seq =
      (raw?.seq != null ? Number(raw.seq) : null) ||
      (raw?.no != null ? Number(raw.no) : null) ||
      null;

    const title = String(raw?.title ?? raw?.expense ?? raw?.content ?? raw?.name ?? '').trim();
    const desc  = String(raw?.desc  ?? raw?.description ?? raw?.note ?? '');
    const payer = String(raw?.payer ?? raw?.paidBy ?? raw?.payee ?? '');

    const payDate    = raw?.payDate ?? raw?.paidAt ?? raw?.date ?? null;
    const receiptUrl = String(raw?.receiptUrl ?? raw?.receipt ?? raw?.url ?? '').trim();

    let status = String(raw?.status ?? '').trim();
    if(status === '精算前') status = '精算依頼前';
    if(status === '依頼前') status = '精算依頼前';
    if(status === '依頼済') status = '精算依頼済み';
    if(status === '精算完了') status = '精算済み';

    const requestDate = raw?.requestDate ?? raw?.requestedAt ?? null;
    const settleDate  = raw?.settleDate  ?? raw?.doneAt ?? null;

    return { rowNumber, seq, title, desc, payer, payDate, receiptUrl, status, requestDate, settleDate, _raw: raw };
  }

  function getFilter(){
    return {
      kw: (fKw?.value || ''),
      payer: (fPayer?.value || ''),
      from: (fFrom?.value || ''),
      to: (fTo?.value || ''),
      status: (fStatus?.value || ''),
    };
  }

  function matchesFilter(x, f){
    const kw = (f.kw||'').trim().toLowerCase();
    if(kw){
      const t = (x.title||'').toLowerCase();
      const d = (x.desc||'').toLowerCase();
      if(!t.includes(kw) && !d.includes(kw)) return false;
    }

    if((f.payer||'').trim()){
      if(String(x.payer||'').trim() !== f.payer.trim()) return false;
    }

    if((f.status||'').trim()){
      if(String(x.status||'').trim() !== f.status.trim()) return false;
    }

    const from = f.from ? new Date(f.from + 'T00:00:00') : null;
    const to   = f.to   ? new Date(f.to   + 'T23:59:59') : null;

    if(from || to){
      const pd = x.payDate ? new Date(x.payDate) : null;
      if(!pd || isNaN(pd.getTime())) return false;
      if(from && pd.getTime() < from.getTime()) return false;
      if(to   && pd.getTime() > to.getTime()) return false;
    }
    return true;
  }

  function emptyBox(msg){
    return `<div class="notice" style="padding:10px; border-radius:14px;">${esc(msg)}</div>`;
  }

  function buildRowCard(x){
    const rn = Number(x.rowNumber);
    const hasRn = Number.isFinite(rn) && rn > 0;
    const isSel = hasRn ? selected.has(rn) : false;

    const receipt = (x.receiptUrl||'').trim()
      ? `<a href="${esc(x.receiptUrl)}" target="_blank" rel="noopener" class="link">領収書</a>`
      : `<span style="color:var(--muted);">（領収書なし）</span>`;

    const badge = `<span class="pill">${esc(x.status||'（未設定）')}</span>`;
    const payDate  = fmtYMD(x.payDate);
    const reqDate  = fmtYMD(x.requestDate);
    const doneDate = fmtYMD(x.settleDate);

    const lineLabel = (x.seq != null && !Number.isNaN(Number(x.seq)))
      ? `SEQ：${Number(x.seq)}`
      : (hasRn ? `SEQ：${rn}` : `SEQ：?`);

    return `
      <div class="notice ac-row ${isSel ? 'is-selected' : ''}"
        ${hasRn ? `data-row="${rn}"` : ''}
        style="display:flex; gap:10px; align-items:flex-start; padding:10px; border-radius:14px; cursor:${hasRn?'pointer':'default'};">
        ${hasRn ? `<input class="ac-check" type="checkbox" data-sel="${rn}" ${isSel ? 'checked' : ''} onclick="event.stopPropagation()">`
                : `<span style="width:18px; height:18px; display:inline-block;"></span>`}
        <div style="min-width:0; flex:1 1 auto;">
          <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
            <b style="white-space:nowrap;">${esc(x.title||'（タイトルなし）')}</b>
            ${badge}
          </div>
          <div style="margin-top:6px; color:var(--muted); line-height:1.5; word-break:break-word;">
            ${esc(x.desc||'')}
          </div>
          <div style="margin-top:8px; display:flex; gap:10px; flex-wrap:wrap; color:var(--muted);">
            <span>${lineLabel}</span>
            <span>支払者：${esc(x.payer||'')}</span>
            <span>支払日：${esc(payDate||'')}</span>
            ${reqDate ? `<span>依頼日：${esc(reqDate)}</span>` : ``}
            ${doneDate ? `<span>精算日：${esc(doneDate)}</span>` : ``}
            <span>${receipt}</span>
          </div>
        </div>
      </div>
    `;
  }

  // ===== 描画 =====
  function render(){
    const f = getFilter();

    // 破棄になった明細は、選択状態から必ず外す（画面に出ないため）
    for (const rn of Array.from(selected)) {
      const x = allExpenses.find(e => Number(e.rowNumber) === Number(rn));
      if (x && String(x.status || '').trim() === '破棄') selected.delete(rn);
    }

    const filtered = (allExpenses||[]).filter(x=>{
      // 破棄は常に非表示
      if(String(x.status||'').trim()==='破棄') return false;
      return matchesFilter(x, f);
    });

    const pre  = filtered.filter(x=>String(x.status||'').trim()==='精算依頼前');
    const req  = filtered.filter(x=>String(x.status||'').trim()==='精算依頼済み');
    const done = filtered.filter(x=>String(x.status||'').trim()==='精算済み');

    hostPre.innerHTML  = pre.length  ? `<div class="ac-list">${pre.map(buildRowCard).join('')}</div>` : emptyBox('該当なし');
    hostReq.innerHTML  = req.length  ? `<div class="ac-list">${req.map(buildRowCard).join('')}</div>` : emptyBox('該当なし');
    hostDone.innerHTML = done.length ? `<div class="ac-list">${done.map(buildRowCard).join('')}</div>` : emptyBox('該当なし');

    setStatus(`表示：${filtered.length}件（依頼前${pre.length} / 依頼済${req.length} / 済${done.length}）`, false);
  }

  function onListClick(e){
    const row = e.target.closest('.ac-row[data-row]');
    if(!row) return;
    const rn = Number(row.dataset.row);
    if(!Number.isFinite(rn)) return;
    if(e.target && e.target.matches('input[type="checkbox"][data-sel]')) return;

    if(selected.has(rn)) selected.delete(rn);
    else selected.add(rn);
    render();
  }
  function onCheckboxChange(e){
    const cb = e.target;
    if(!cb || !cb.matches('input[type="checkbox"][data-sel]')) return;
    const rn = Number(cb.dataset.sel);
    if(!Number.isFinite(rn)) return;
    if(cb.checked) selected.add(rn);
    else selected.delete(rn);
    render();
  }
  [hostPre, hostReq, hostDone].forEach(h=>{
    h.addEventListener('click', onListClick);
    h.addEventListener('change', onCheckboxChange);
  });

  // ---- data load
  async function loadAll(){
    setStatus('会計シートから取得中...', true);
    const res = await callServer('api_listExpenses', {});
    if(!res || !res.ok) throw new Error(res?.message || '取得に失敗しました');

    const rawList = Array.isArray(res.expenses) ? res.expenses : [];
    const list = rawList.map(normalizeExpense);

    const missingRow = list.some(x => !Number.isFinite(Number(x.rowNumber)));
    if(missingRow){
      console.warn('rowNumber が不足しています。api_listExpenses が rowNumber を返しているか確認してください。', res);
    }
    return list;
  }

  // ---- modal helpers
  function setModalStatus(t, busyFlg){
    mStatus.textContent = t;
    mStatus.style.borderColor = busyFlg ? 'rgba(78,161,255,.55)' : 'var(--line)';
  }

  function setReceiptLink(url){
    currentReceiptUrl = String(url||'').trim();
    mReceiptLink.innerHTML = currentReceiptUrl
      ? `<a class="link" href="${esc(currentReceiptUrl)}" target="_blank" rel="noopener">${esc(currentReceiptUrl)}</a>`
      : `<span style="color:var(--muted);">（なし）</span>`;

    // 削除ボタン表示制御（編集モードで、削除予約されておらず、URLがある時のみ）
    const canDelete = (modalMode === 'edit') && !!currentReceiptUrl && !receiptDeleteRequested;
    if(btnDeleteReceipt) btnDeleteReceipt.style.display = canDelete ? 'inline-flex' : 'none';
  }

  function resetModal(){
    mTitleInput.value = '';
    mDescInput.value = '';
    mPayer.value = '';
    mPayDate.value = '';
    mStatusSel.value = '精算依頼前';
    mFile.value = '';

    currentReceiptUrl = '';
    originalReceiptUrl = '';
    receiptDeleteRequested = false;

    mReceiptLink.innerHTML = `<span style="color:var(--muted);">（なし）</span>`;
    if(fileNameEl) fileNameEl.textContent = '';
    if(btnDeleteReceipt) btnDeleteReceipt.style.display = 'none';
  }

  function openCreate(){
    modalMode = 'create';
    editingRowNumber = null;
    mTitle.textContent = '経費追加';

    resetModal();
    setModalStatus('入力してください。', false);
    openModal();
  }

  function pickSelectedOne(){
    const arr = Array.from(selected.values());
    if(arr.length !== 1) throw new Error('修正は1件のみ選択してください。');
    const rn = arr[0];
    const x = allExpenses.find(e => Number(e.rowNumber) === Number(rn));
    if(!x) throw new Error('選択行のデータが見つかりません。再取得してください。');
    return x;
  }

  function openEdit(expense){
    modalMode = 'edit';
    editingRowNumber = expense.rowNumber;
    mTitle.textContent = `経費修正（SEQ：${expense.seq ?? editingRowNumber}）`;

    resetModal();
    mTitleInput.value = expense.title || '';
    mDescInput.value  = expense.desc || '';
    mPayer.value      = expense.payer || '';
    mPayDate.value    = isoToYMD(expense.payDate);
    mStatusSel.value  = expense.status || '精算依頼前';

    originalReceiptUrl = String(expense.receiptUrl || '').trim();
    receiptDeleteRequested = false;

    setReceiptLink(originalReceiptUrl);
    updatePlannedFileName();

    setModalStatus('修正内容を入力してください。', false);
    openModal();
  }

  function fileToBase64(file){
    return new Promise((resolve, reject)=>{
      const reader = new FileReader();
      reader.onload = ()=>{
        const dataUrl = String(reader.result||'');
        const m = dataUrl.match(/^data:(.+);base64,(.+)$/);
        if(!m) return reject(new Error('base64 変換に失敗しました'));
        resolve({ mime:m[1], base64:m[2] });
      };
      reader.onerror = ()=>reject(new Error('ファイル読み込みに失敗しました'));
      reader.readAsDataURL(file);
    });
  }

  function buildReceiptFileName(){
    const file = mFile?.files && mFile.files[0] ? mFile.files[0] : null;
    if(!file) return '';

    const date  = mPayDate.value || `yyyy-MM-dd`;
    const payer = (mPayer.value || '支払者').trim();
    const title = (mTitleInput.value || '').trim();
    if(!date || !payer || !title) return '';

    const ymd = date.replaceAll('-', '');
    // 拡張子はサーバ側でも確定するが、UI表示は予測でOK
    const ext = (file.type || '').includes('pdf') ? 'pdf' : 'png';
    return `${ymd}_${payer}_${title}.${ext}`;
  }

  function updatePlannedFileName(){
    if(!fileNameEl) return;
    const name = buildReceiptFileName();
    fileNameEl.textContent = name || '';
  }

  // ====== 確認モーダル用：領収書表示仕様（要件通り） ======
  function buildReceiptConfirmLine({ mode, file, originalUrl, currentUrl, deleteRequested, plannedName }){
    const hasNewFile = !!file;
    const newFileName = hasNewFile ? String(file.name || '').trim() : '';
    const hasOriginal = !!String(originalUrl||'').trim();

    // 追加モード
    if(mode === 'create'){
      if(hasNewFile) return `領収書：${newFileName || '（ファイル名不明）'}`;
      return `領収書：なし`;
    }

    // 修正モード
    if(hasOriginal){
      if(hasNewFile){
        return `領収書：${newFileName || '（ファイル名不明）'}`;
      }
      // 新規添付なし
      if(deleteRequested){
        return `領収書：なし`;
      }
      // 現状維持（URL表示）
      const url = String(currentUrl||originalUrl||'').trim();
      return `領収書：${url || 'なし'}`;
    }

    // 修正モード：元々なし
    if(hasNewFile) return `領収書：${newFileName || '（ファイル名不明）'}`;
    return `領収書：なし`;
  }

  function buildConfirmText(payload, ctx){
    const d = payload.data || {};
    const mode = payload.mode === 'edit' ? 'edit' : 'create';
    const title = (mode === 'edit') ? '【修正】' : '【追加】';
    const payDate = d.payDate || '';

    const receiptLine = buildReceiptConfirmLine({
      mode,
      file: ctx.file,
      originalUrl: ctx.originalReceiptUrl,
      currentUrl: ctx.currentReceiptUrl,
      deleteRequested: ctx.receiptDeleteRequested,
      plannedName: ctx.plannedFileName
    });

    const lines = [
      `${title}`,
      `経費内容：${d.title || ''}`,
      `説明：${d.desc || ''}`,
      `支払者：${d.payer || ''}`,
      `支払日：${payDate}`,
      `ステータス：${d.status || ''}`,
      receiptLine
    ];

    // 新規添付がある場合は注意書き
    if(ctx.file){
      const planned = (ctx.plannedFileName || '').trim();
      if(planned){
        lines.push('');
        lines.push(`※領収書は「${planned}」という名前で保存されます`);
      }else{
        lines.push('');
        lines.push(`※領収書は、支払日・支払者・経費内容から生成した名前で保存されます`);
      }
    }

    return lines.join('\n');
  }

  // ===== 保存フロー =====
  async function buildSavePayload(){
    const title = (mTitleInput.value||'').trim();
    if(!title){
      App.modal?.warn('経費内容は必須です。');
      return null;
    }

    const file = mFile.files && mFile.files[0] ? mFile.files[0] : null;

    // 差し替え（編集 + 新規添付 + 既存URLあり（削除予約で空にしてない））→確認
    let oldReceiptUrlForUpload = '';
    if(modalMode === 'edit' && file && String(originalReceiptUrl||'').trim() && !receiptDeleteRequested){
      const ok = await App.modal?.confirm('すでに保存済みの領収書に上書き保存されます。よろしいですか？',{
        okText:'はい', cancelText:'いいえ'
      });
      if(!ok) return null;
      oldReceiptUrlForUpload = String(originalReceiptUrl||'').trim();
    }

    const payload = {
      mode: modalMode,
      rowNumber: editingRowNumber,
      data: {
        title,
        desc: (mDescInput.value||'').trim(),
        payer: (mPayer.value||'').trim(),
        payDate: (mPayDate.value||'') ? String(mPayDate.value) : null,
        status: (mStatusSel.value||'精算依頼前').trim(),
        receiptUrl: receiptDeleteRequested ? '' : (currentReceiptUrl || ''),
        // ★削除用（GAS側 api_upsertExpense が見る）
        removeReceipt: (modalMode==='edit') ? !!receiptDeleteRequested : false,
        oldReceiptUrl: (modalMode==='edit') ? (originalReceiptUrl || '') : ''
      }
    };

    return {
      payload,
      file,
      oldReceiptUrlForUpload,
      // confirm表示用
      ctx: {
        file,
        plannedFileName: (fileNameEl?.textContent || '').trim(),
        originalReceiptUrl: (originalReceiptUrl || ''),
        currentReceiptUrl: (currentReceiptUrl || ''),
        receiptDeleteRequested: !!receiptDeleteRequested
      }
    };
  }

  async function saveModalCore(p){
    const payload = p?.payload;
    const file = p?.file;
    const oldReceiptUrlForUpload = p?.oldReceiptUrlForUpload || '';

    if(!payload) throw new Error('payloadがありません');

    setModalStatus('登録中...', true);
    mSave.disabled = true;

    // 新規添付があるなら先にアップロード
    if(file){
      const { mime, base64 } = await fileToBase64(file);
      const payDate = (payload.data.payDate||'');
      const payer   = (payload.data.payer||'').trim();
      const title2  = (payload.data.title||'').trim();

      const up = await callServer('api_uploadReceipt', {
        name: file.name || 'receipt',
        mime,
        base64,
        payDate,
        payer,
        title: title2,
        oldReceiptUrl: oldReceiptUrlForUpload // 差し替え時だけ入る
      });
      if(!up || !up.ok) throw new Error(up?.message || '領収書アップロードに失敗しました');

      // サーバが返すURLを採用
      currentReceiptUrl = up.url || '';
      payload.data.receiptUrl = currentReceiptUrl;

      // 差し替えで oldReceiptUrl を送って削除したケースでは、
      // GAS側がさらに upsert で removeReceipt を見て削除しないよう、removeReceiptは維持してOK（falseのまま）
      payload.data.removeReceipt = false;
      payload.data.oldReceiptUrl = '';
    }

    const res = await callServer('api_upsertExpense', payload);
    if(!res || !res.ok) throw new Error(res?.message || '保存に失敗しました');

    allExpenses = await loadAll();
    render();

    return res;
  }

  async function performSave(p){
    busy.show();
    try{
      const res = await saveModalCore(p);

      busy.hide();
      App.modal?.info(res.message || '保存しました');
      closeModal();
      setStatus('完了しました。', false);

    }catch(e){
      console.error(e);
      busy.hide();
      setModalStatus('保存に失敗しました：' + (e.message||e), false);
      App.modal?.error('保存に失敗しました：' + (e.message||e));
    }finally{
      mSave.disabled = false;
    }
  }

  function toggleAllByStatus(status){
    const f = getFilter();
    const targets = (allExpenses||[])
      .filter(x=>matchesFilter(x, f))
      .filter(x=>String(x.status||'').trim()===status)
      .filter(x=>Number.isFinite(Number(x.rowNumber)));

    if(!targets.length) return;

    const allSelected = targets.every(x => selected.has(Number(x.rowNumber)));
    if(allSelected) targets.forEach(x=>selected.delete(Number(x.rowNumber)));
    else targets.forEach(x=>selected.add(Number(x.rowNumber)));

    render();
  }

  async function bulkUpdate(fromStatus, toStatus){
    const selectedRows = Array.from(selected.values());
    if(!selectedRows.length) return App.modal?.warn('対象を選択してください。');

    const invalid = selectedRows
      .map(rn => allExpenses.find(x=>Number(x.rowNumber)===Number(rn)))
      .filter(x => !x || String(x.status||'').trim() !== fromStatus);

    if(invalid.length){
      return App.modal?.warn(`「${fromStatus}」以外が含まれています。対象を見直してください。`);
    }

    const ok = await App.modal?.confirm(`${selectedRows.length}件を「${toStatus}」に変更します。よろしいですか？`,{
      okText: 'はい',
      cancelText: 'いいえ'
    });
    if(!ok) return;

    busy.show();
    try{
      const res = await callServer('api_bulkUpdateExpenseStatus', {
        rowNumbers: selectedRows,
        newStatus: toStatus
      });
      if(!res || !res.ok) throw new Error(res?.message || '更新に失敗しました');

      allExpenses = await loadAll();
      selected.clear();
      render();

      App.modal?.info(res.message || '更新しました');
    }catch(e){
      console.error(e);
      App.modal?.error('更新に失敗しました：' + (e.message||e));
    }finally{
      busy.hide();
    }
  }

  // ===== 入力補助（blur）=====
  function showFieldWarn(inputEl, msg){
    if(!inputEl) return;
    const id = inputEl.id + '_warn';
    let w = document.getElementById(id);
    if(!w){
      w = document.createElement('div');
      w.id = id;
      w.style.marginTop = '6px';
      w.style.fontSize = '12px';
      w.style.color = '#ffb4b4';
      inputEl.parentElement.appendChild(w);
    }
    w.textContent = msg || '';
    inputEl.style.borderColor = msg ? 'rgba(255,120,120,.75)' : '';
  }
  function clearFieldWarn(inputEl){ showFieldWarn(inputEl,''); }

  function bindBasicFieldBehaviors(){
    if(!mTitleInput) return;
    mTitleInput.onblur = () => {
      const v = (mTitleInput.value || '').trim();
      if(!v) showFieldWarn(mTitleInput,'経費内容は必須です。');
      else clearFieldWarn(mTitleInput);
    };
  }

  // ===== 保存済み領収書の削除ボタン =====
  if(btnDeleteReceipt){
    btnDeleteReceipt.addEventListener('click', async ()=>{
      if(modalMode !== 'edit') return;
      if(!String(originalReceiptUrl||'').trim()) return;

      const ok = await App.modal?.confirm('保存済みの領収書を削除します。よろしいですか？',{
        okText:'削除する', cancelText:'やめる'
      });
      if(!ok) return;

      // UI上は「削除予定」として扱う
      receiptDeleteRequested = true;
      currentReceiptUrl = '';
      setReceiptLink('');

      // 差し替えのために選んでいたファイルもクリア（混乱防止）
      if(mFile) mFile.value = '';
      updatePlannedFileName();

      App.modal?.info('削除を予約しました（登録を押すと反映されます）');
    });
  }

  // ---- events
  btnAdd.addEventListener('click', openCreate);

  btnEdit.addEventListener('click', ()=>{
    try{
      const x = pickSelectedOne();
      openEdit(x);
    }catch(e){
      App.modal?.warn(e.message||String(e));
    }
  });

  btnAllPre.addEventListener('click', ()=> toggleAllByStatus('精算依頼前'));
  btnAllReq.addEventListener('click', ()=> toggleAllByStatus('精算依頼済み'));

  btnToReq.addEventListener('click', ()=> bulkUpdate('精算依頼前', '精算依頼済み'));
  btnToDone.addEventListener('click', ()=> bulkUpdate('精算依頼済み', '精算済み'));

  mClose.addEventListener('click', closeModal);

  mSave.addEventListener('click', async ()=>{
    const built = await buildSavePayload();
    if(!built) return;

    const confirmText = buildConfirmText(built.payload, built.ctx);

    const ok = await App.modal?.confirm(confirmText, {
      title: 'この内容で登録します。よろしいですか？',
      okText: 'はい',
      cancelText: 'いいえ'
    });
    if(!ok) return;

    await performSave(built);
  });

  filterOpen.addEventListener('click', openFilter);
  filterClose.addEventListener('click', closeFilter);

  btnApply.addEventListener('click', ()=>{
    render();
    closeFilter();
  });

  btnClear.addEventListener('click', ()=>{
    fKw.value=''; fPayer.value=''; fFrom.value=''; fTo.value=''; fStatus.value='';
    render();
  });

  // ファイル名プレビュー更新
  mPayDate.addEventListener('input', updatePlannedFileName);
  mPayer.addEventListener('change', updatePlannedFileName);
  mTitleInput.addEventListener('input', updatePlannedFileName);
  mFile.addEventListener('change', ()=>{
    // 新規添付したら、削除予約は解除（＝新しいファイルで置き換える意図が明確）
    if(mFile.files && mFile.files[0]){
      receiptDeleteRequested = false;
      // 削除ボタンは既存URLがあり、削除予約が解除された時のみ復活する
      setReceiptLink(currentReceiptUrl || originalReceiptUrl || '');
    }
    updatePlannedFileName();
  });

  // ---- init
  (async ()=>{
    try{
      setStatus('読み込み中...', true);
      allExpenses = await loadAll();
      selected.clear();
      render();
    }catch(e){
      console.error(e);
      setStatus('読み込みに失敗しました：' + (e.message||e), false);
      App.modal?.error('読み込みに失敗しました：' + (e.message||e));
    }
  })();

  bindBasicFieldBehaviors();
};
</script>
