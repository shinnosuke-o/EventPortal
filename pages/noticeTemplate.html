<section class="card">
  <h1>案内テンプレ作成</h1>
  <p>イベント情報を元に案内文を自動生成します。</p>
  <div class="notice" id="nt_status">イベントを選択してください。</div>
</section>

<section class="card">
  <h2>作成</h2>

  <div class="field">
    <div class="label">イベントを選択してください（必須）</div>

    <div class="sheet-select-row">
      <select id="nt_eventSelect" class="sheet-select">
        <option value="">選択してください</option>
      </select>

      <button id="nt_reloadBtn" class="btn secondary sheet-reload-btn" type="button">
        イベント読み込み
      </button>
    </div>
  </div>

  <div class="field" style="margin-top:14px;">
    <div class="label">案内文（生成結果）</div>
    <textarea id="nt_text" rows="16" placeholder="イベントを選択するとここに案内文が表示されます。"></textarea>

    <div class="btn-row" style="margin-top:10px;">
      <div style="flex:1 1 auto;"></div>
      <button id="nt_copyBtn" class="btn btn-primary" type="button">コピー</button>
    </div>
  </div>
</section>

<!-- ✅ テンプレート編集（新規） -->
<section class="card">
  <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
    <h2 style="margin:0;">テンプレート編集</h2>
    <div style="flex:1 1 auto;"></div>
    <button id="nt_tplToggle" class="btn secondary" type="button">開く</button>
  </div>

  <div id="nt_tplArea" style="display:none; margin-top:12px;">
    <div style="
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin:10px 0;
      align-items:center;
    ">
      <div style="font-size:12px; color:var(--muted); margin-right:6px;">
        差し込み：
      </div>

      <button class="btn secondary nt-insert" type="button" data-token="《イベント名》">イベント名</button>
      <button class="btn secondary nt-insert" type="button" data-token="《開催日》">開催日</button>
      <button class="btn secondary nt-insert" type="button" data-token="《開催場所》">開催場所</button>
      <button class="btn secondary nt-insert" type="button" data-token="《練習日》">練習日</button>
      <button class="btn secondary nt-insert" type="button" data-token="《参加条件》">参加条件</button>
      <button class="btn secondary nt-insert" type="button" data-token="《回答期限》">回答期限</button>
      <button class="btn secondary nt-insert" type="button" data-token="《回答フォームURL》">回答フォームURL</button>
      <button class="btn secondary nt-insert" type="button" data-token="《確認シートURL》">確認シートURL</button>
    </div>

    <div class="field">
      <div class="label">案内テンプレート（保存されます）</div>
      <textarea id="nt_tpl" rows="16"></textarea>
    </div>

    <div class="btn-row" style="margin-top:10px; display:flex; gap:10px; justify-content:flex-end;">
      <button id="nt_tplReset" class="btn secondary" type="button">初期化</button>
      <button id="nt_tplSave" class="btn btn-primary" type="button">保存</button>
    </div>
  </div>
</section>

<script>
window.noticeTemplateInit = async function noticeTemplateInit() {
  const App = window.App || {};
  const $ = (s)=>document.querySelector(s);

  const sel = $('#nt_eventSelect');
  const txt = $('#nt_text');
  const statusEl = $('#nt_status');

  const reloadBtn = $('#nt_reloadBtn');
  const copyBtn = $('#nt_copyBtn');

  const tplToggle = $('#nt_tplToggle');
  const tplArea   = $('#nt_tplArea');
  const tplText   = $('#nt_tpl');
  const tplSave   = $('#nt_tplSave');
  const tplReset  = $('#nt_tplReset');

  const tplInserts = document.querySelectorAll('.nt-insert');

  const setStatus = (text, busy) => App.setStatus(statusEl, text, busy);

  // ==========================
  // Template (default)
  // ==========================
  const DEFAULT_TEMPLATE =
`【《イベント名》出欠】

⚠️回答期限：《回答期限》⚠️
未定の方も必ず回答するようにしてください。

●イベント名
《イベント名》
●開催日
《開催日》
●開催場所
《開催場所》
●練習日(予定)
《練習日》
●参加条件
《参加条件》

■回答フォーム
《回答フォームURL》
■回答確認シート
《確認シートURL》
`;

  // 現在のテンプレ（メモリ上）
  let currentTemplate = DEFAULT_TEMPLATE;

  // ==========================
  // Helpers
  // ==========================
  const WEEK = ['日','月','火','水','木','金','土'];

  function toMDW(v){
    if(!v) return '';
    const d = (v instanceof Date) ? v : new Date(v);
    if (isNaN(d.getTime())) return '';
    return `${d.getMonth()+1}/${d.getDate()}(${WEEK[d.getDay()]})`;
  }

  function normalizePractice(text){
    return (text || '').split(/\r?\n/).map(s=>s.trim()).filter(Boolean).join('、');
  }

  function buildDateLine(d){
    const from = d.dateFrom ? new Date(d.dateFrom) : null;
    const to   = d.dateTo ? new Date(d.dateTo) : null;
    if (!from) return '';
    const f = toMDW(from);
    if (!to || from.toDateString() === to.toDateString()) return f;
    return `${f}～${toMDW(to)}`;
  }

  function applyTemplate(d, tpl){
    const values = {
      '《イベント名》': d.eventName || '',
      '《開催日》': buildDateLine(d) || '',
      '《開催場所》': d.place || '',
      '《練習日》': normalizePractice(d.practice || ''),
      '《参加条件》': d.condition || '',
      '《回答期限》': d.deadline ? toMDW(new Date(d.deadline)) : '',
      '《回答フォームURL》': d.formUrl || '',
      '《確認シートURL》': d.publicUrl || ''
    };

    let out = String(tpl || '');
    Object.keys(values).forEach(k=>{
      out = out.split(k).join(String(values[k]));
    });
    return out;
  }

  // ✅ 追加：差し込み（カーソル位置に入れる）
  function insertAtCursor(textarea, insertText){
    if (!textarea) return;
    textarea.focus();
    const start = (typeof textarea.selectionStart === 'number') ? textarea.selectionStart : textarea.value.length;
    const end   = (typeof textarea.selectionEnd === 'number') ? textarea.selectionEnd : textarea.value.length;
    const before = textarea.value.slice(0, start);
    const after  = textarea.value.slice(end);
    textarea.value = before + insertText + after;
    const pos = start + insertText.length;
    textarea.selectionStart = textarea.selectionEnd = pos;
  }

  // ==========================
  // Template load/save (Server)
  // ==========================
  async function loadTemplate(){
    try{
      const res = await App.callWithTimeout('api_getNoticeTemplate', {}, 15000, 'テンプレ取得');
      if (res && res.ok && typeof res.template === 'string' && res.template.trim()){
        currentTemplate = res.template;
      } else {
        currentTemplate = DEFAULT_TEMPLATE;
      }
    }catch(e){
      console.warn('template load failed -> default', e);
      currentTemplate = DEFAULT_TEMPLATE;
    }

    if (tplText) tplText.value = currentTemplate;
  }

  // ✅ 修正：保存API名の間違い（'c' -> api_setNoticeTemplate）
  async function saveTemplateToServer(newTpl){
    const tpl = String(newTpl || '').trim();
    if (!tpl) return App.modal?.warn('テンプレートが空です。');

    App.busy?.show('テンプレートを保存しています。\nしばらくお待ちください。', { title: '保存中...' });

    try{
      const res = await App.callWithTimeout(
        'api_setNoticeTemplate',           // ★ここが最小修正の本体
        { template: tpl },
        15000,
        'テンプレ保存'
      );
      if (!res || !res.ok) throw new Error(res?.message || '保存に失敗しました');

      currentTemplate = tpl;
      return App.modal?.info('テンプレートを保存しました');
    }catch(e){
      console.error(e);
      return App.modal?.error('テンプレ保存に失敗しました：' + (e.message || e));
    }finally{
      App.busy?.hide();
    }
  }

  // ==========================
  // Events
  // ==========================
  async function loadEventList(){
    setStatus('イベント一覧を読み込み中...', true);

    const res = await App.callWithTimeout('api_listGuideEvents', {}, 15000, 'イベント一覧');
    if (!res || res.ok !== true) throw new Error(res?.message || 'イベント一覧取得に失敗しました');

    const names = res.data || [];
    sel.innerHTML = '<option value="">選択してください</option>';

    (names || []).forEach(n=>{
      const v = String(n ?? '').trim();
      if(!v) return;
      const opt = document.createElement('option');
      opt.value = v;
      opt.textContent = v;
      sel.appendChild(opt);
    });

    setStatus('イベントを選択してください。', false);
  }

  async function onSelectEvent(){
    const name = (sel.value || '').trim();

    if(!name){
      txt.value = '';
      setStatus('イベントを選択してください。', false);
      return;
    }

    setStatus('案内文を作成中...', true);
    App.busy?.show('案内文を作成しています。\nしばらくお待ちください。', { title: '作成中...' });

    try{
      const res = await App.callWithTimeout('api_getGuideEvent', { eventName: name }, 15000, 'イベント取得');
      if (!res) throw new Error('サーバー応答が空です（null）。');
      if (!res.ok) throw new Error(res.message || '取得失敗');

      const d = res.data;
      if (!d || !d.eventName) throw new Error('イベント情報が取得できませんでした（空）。');

      txt.value = applyTemplate(d, currentTemplate);
      setStatus('案内文を作成しました。', false);
    } catch(e){
      console.error(e);
      setStatus('作成に失敗しました：' + (e.message || e), false);
      App.modal?.error('作成に失敗しました：' + (e.message || e));
    } finally{
      App.busy?.hide();
    }
  }

  async function reload(){
    sel.value = '';
    txt.value = '';
    await loadEventList();
  }

  async function copyNotice(){
    const text = (txt.value || '').trim();
    if(!text) return App.modal?.warn('コピーする内容がありません');

    try{
      if (App.copyToClipboard) await App.copyToClipboard(text);
      else if(navigator.clipboard?.writeText) await navigator.clipboard.writeText(text);
      else{
        const tmp = document.createElement('textarea');
        tmp.value = text;
        document.body.appendChild(tmp);
        tmp.select();
        document.execCommand('copy');
        document.body.removeChild(tmp);
      }
      App.modal?.info('コピーしました');
    }catch(e){
      console.error(e);
      App.modal?.error('コピーに失敗しました');
    }
  }

  // ==========================
  // Template UI events
  // ==========================
  if (tplToggle){
    tplToggle.onclick = ()=>{
      const open = (tplArea.style.display !== 'none');
      tplArea.style.display = open ? 'none' : '';
      tplToggle.textContent = open ? '開く' : '閉じる';
    };
  }

  if (tplSave){
    tplSave.onclick = async ()=>{
      // ✅ 保存して currentTemplate 更新
      const ok = await saveTemplateToServer(tplText.value);
      // ✅ 画面上の生成結果も即反映（イベント選択中なら再生成）
      if (ok && sel.value) await onSelectEvent();
    };
  }

  if (tplReset){
    tplReset.onclick = ()=>{
      tplText.value = DEFAULT_TEMPLATE;
      App.modal?.info('初期テンプレートに戻しました（保存はまだです）');
    };
  }

  // ==========================
  // Bind
  // ==========================
  sel.onchange = onSelectEvent;
  if (reloadBtn) reloadBtn.onclick = reload;
  if (copyBtn) copyBtn.onclick = copyNotice;

  tplInserts.forEach(btn=>{
    btn.onclick = ()=>{
      insertAtCursor(tplText, btn.dataset.token || '');
    };
  });

  // ==========================
  // Start
  // ==========================
  await loadTemplate();     // ✅ テンプレ取得
  await loadEventList();    // ✅ イベント取得
  setStatus('イベントを選択してください。', false);
};
</script>
